<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>MURAIN 寄賣精品｜官方旗艦</title>
  <style>
    /* --- 核心變數設定：高級黑金配色 --- */
    :root{
      --bg: #030304; /* 更深邃的黑 */
      --surface: #121214;
      --surface-glass: rgba(18, 18, 20, 0.85);
      --gold: #d4af58; /* 香檳金 */
      --gold-dim: rgba(212, 175, 88, 0.15);
      --text: #ffffff;
      --text-sub: #8c8c90;
      --line: rgba(255, 255, 255, 0.08);
      --radius-lg: 24px;
      --radius-sm: 12px;
      --shadow: 0 10px 40px -10px rgba(0,0,0,0.8);
      --font-main: "Helvetica Neue", Helvetica, Arial, sans-serif;
      --font-serif: "Times New Roman", Times, serif; /* 精品常用的襯線字體 */
    }

    /* --- 基礎重置 --- */
    *{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
    body{
      margin: 0;
      font-family: var(--font-main);
      background-color: var(--bg);
      /* 移除原本雜亂的背景，改為極簡深色微噪點質感 */
      background-image: radial-gradient(circle at 50% 0%, #1a1a20 0%, var(--bg) 60%);
      color: var(--text);
      padding-bottom: 80px; /* 避開底部可能的遮擋 */
    }
    a{ color: inherit; text-decoration: none; }
    input, select, button { font-family: inherit; }

    /* --- 版面容器 --- */
    .wrap{
      max-width: 800px; /* 手機版不需太寬，鎖定在舒適閱讀寬度 */
      margin: 0 auto;
      padding: 0 16px;
    }

    /* --- 置頂導航 (Glassmorphism) --- */
    .topbar {
      position: sticky;
      top: 0;
      z-index: 40;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      margin: 0 -16px 20px -16px; /* 滿版延伸 */
      background: var(--surface-glass);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--line);
    }

    .brand { display: flex; flex-direction: column; }
    .brand h1 {
      margin: 0;
      font-family: var(--font-serif); /* 品牌名使用襯線體 */
      font-size: 22px;
      font-weight: 400;
      letter-spacing: 1px;
      color: var(--gold);
    }
    .brand .sub { display: none; } /* 手機版隱藏次要說明，保持乾淨 */

    /* 購物車與按鈕優化 */
    .pill {
      font-size: 11px; color: var(--text-sub);
      background: rgba(255,255,255,0.05);
      padding: 4px 10px; border-radius: 99px;
      display: none; /* 手機版隱藏非必要資訊 */
    }
    @media(min-width: 600px){ .pill { display: inline-flex; } }

    .btn {
      appearance: none;
      background: var(--text);
      color: #000;
      border: none;
      padding: 8px 18px;
      border-radius: 99px;
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn:active { transform: scale(0.96); opacity: 0.9; }

    /* --- Banner 大圖區 --- */
    .banner {
      margin: 0 -16px 24px -16px; /* 滿版 */
      position: relative;
      aspect-ratio: 16/9; /* 手機版比例 */
      overflow: hidden;
      box-shadow: var(--shadow);
    }
    .banner::after {
      content: ''; position: absolute; inset: 0;
      background: linear-gradient(0deg, var(--bg) 0%, transparent 40%);
    }
    .banner img { width: 100%; height: 100%; object-fit: cover; display: block; }

    /* --- 控制列 (搜尋/篩選) --- */
    .controls {
      display: flex; flex-direction: column; gap: 12px;
      margin-bottom: 24px;
    }
    .leftCtrls {
      display: flex; gap: 10px; width: 100%;
    }
    /* 輸入框高級化 */
    select, input {
      background: #1c1c1f;
      border: 1px solid var(--line);
      color: var(--text);
      border-radius: 12px;
      padding: 12px 16px;
      outline: none;
      font-size: 14px;
      flex: 1; /* 讓寬度自適應 */
    }
    select:focus, input:focus { border-color: var(--gold); }
    
    .btn.ghost {
      background: transparent;
      color: var(--text-sub);
      border: 1px solid var(--line);
      flex: 0 0 auto;
    }
    .rightCtrls { display: none; } /* 手機版隱藏 API 顯示 */

    /* --- 商品網格 (核心改動) --- */
    .grid {
      display: grid;
      /* 手機版：單欄大圖 (Instagram 風格) */
      grid-template-columns: 1fr; 
      gap: 32px; /* 拉大間距，增加呼吸感 */
    }

    /* 平板以上改為雙欄 */
    @media (min-width: 600px){
      .grid { grid-template-columns: 1fr 1fr; gap: 20px; }
    }

    /* --- 商品卡片 (極簡無框設計) --- */
    .card {
      background: transparent;
      border: none;
      border-radius: 0;
      box-shadow: none;
      display: flex;
      flex-direction: column;
      position: relative;
    }
    
    /* 圖片區：4:5 黃金比例，適合服飾與包包 */
    .imgbox {
      width: 100%;
      aspect-ratio: 4/5; 
      border-radius: var(--radius-lg);
      overflow: hidden;
      background: #121214;
      position: relative;
      margin-bottom: 14px;
      border: 1px solid rgba(255,255,255,0.03);
    }
    .imgbox img {
      width: 100%; height: 100%; object-fit: cover;
      transition: transform 0.6s cubic-bezier(0.2, 0.8, 0.2, 1);
    }
    /* 圖片點擊微放大效果 */
    .card:active .imgbox img { transform: scale(1.03); }

    /* 標籤 */
    .badge {
      position: absolute; left: 12px; top: 12px;
      background: rgba(0,0,0,0.6);
      backdrop-filter: blur(4px);
      border: 1px solid rgba(255,255,255,0.1);
      color: #fff;
      font-size: 10px; font-weight: 600; text-transform: uppercase;
      padding: 4px 10px; border-radius: 6px;
      letter-spacing: 0.5px;
    }

    /* 卡片內容 */
    .body { padding: 0 4px; display: flex; flex-direction: column; gap: 6px; }
    
    .title {
      font-size: 16px; 
      font-weight: 400; 
      line-height: 1.4;
      color: var(--text);
      /* 限制兩行 */
      display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
    }
    
    .meta { display: none; } /* 列表頁隱藏 SKU/庫存，保持畫面乾淨 */

    .priceRow {
      display: flex; align-items: center; justify-content: space-between;
      margin-top: 4px;
    }
    .price {
      font-family: var(--font-serif);
      font-size: 18px;
      color: var(--gold);
      letter-spacing: 0.5px;
    }

    .miniBtns { display: flex; gap: 8px; }
    .miniBtn {
      background: transparent;
      border: 1px solid var(--line);
      color: var(--text);
      padding: 6px 14px;
      border-radius: 99px;
      font-size: 12px;
      cursor: pointer;
    }
    .miniBtn.primary {
      background: var(--text);
      color: #000;
      border-color: var(--text);
      font-weight: 700;
    }

    /* --- Modal 彈窗 (手機版 Bottom Sheet 風格) --- */
    .modalMask {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.9);
      backdrop-filter: blur(8px);
      z-index: 100;
      display: none;
      align-items: flex-end; /* 手機版從底部升起 */
      justify-content: center;
      padding: 0;
    }
    /* 電腦版置中 */
    @media(min-width: 768px){ .modalMask { align-items: center; padding: 20px; } }

    .modal {
      width: 100%;
      max-width: 500px;
      background: #18181b;
      border-radius: 24px 24px 0 0; /* 上圓角 */
      border: 1px solid var(--line);
      box-shadow: 0 -10px 40px rgba(0,0,0,0.5);
      display: flex; flex-direction: column;
      max-height: 90vh; /* 最多佔 90% 高度 */
      overflow-y: auto;
      position: relative;
    }
    @media(min-width: 768px){ 
      .modal { border-radius: 24px; max-width: 900px; display: grid; grid-template-columns: 1fr 1fr; overflow: hidden; max-height: 80vh; } 
    }

    .modalL {
      min-height: 300px;
      background: #000;
      display: flex; align-items: center; justify-content: center;
    }
    @media(min-width: 768px){ .modalL { height: 100%; border-right: 1px solid var(--line); } }

    .modalL img { width: 100%; height: 100%; object-fit: contain; }

    .modalR {
      padding: 24px;
      display: flex; flex-direction: column; gap: 16px;
    }
    
    .modalTop h2 { margin: 0; font-size: 20px; font-weight: 400; line-height: 1.4; margin-bottom: 8px; }
    .modalTop .meta { display: flex; flex-direction: column; gap: 4px; font-size: 13px; color: var(--text-sub); }

    .xBtn {
      position: absolute; top: 16px; right: 16px;
      width: 32px; height: 32px;
      border-radius: 50%;
      background: rgba(0,0,0,0.5);
      border: none; color: #fff;
      font-size: 16px; cursor: pointer;
      z-index: 10;
    }

    .desc {
      color: #b0b0b0; font-size: 14px; line-height: 1.7;
      border-top: 1px solid var(--line);
      padding-top: 16px;
      white-space: pre-wrap;
    }

    /* Modal 內的價格列固定在底部 (手機) */
    .modal .priceRow {
      margin-top: auto;
      padding-top: 16px;
    }
    .modal .price { font-size: 24px; }
    .modal .miniBtns button {
      padding: 12px 20px;
      font-size: 14px;
    }

    /* --- Toast --- */
    .toast {
      background: rgba(255,255,255,0.9);
      color: #000;
      font-weight: 600;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
      border: none;
      bottom: 40px;
    }
    
    /* --- YouTube --- */
    .ytWrap { border-radius: 12px; margin-top: 16px; border: none; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <h1>MURAIN</h1>
        <div class="sub">Luxury Consignment</div>
      </div>
      <div style="display:flex;gap:10px;align-items:center;">
        <div class="pill" style="display:none">
          cart_token：<b id="tokenText">-</b>
        </div>
        <button class="btn" id="btnCheckout">Bag</button>
      </div>
    </div>

    <div class="banner">
      <img src="./banner.png" alt="MURAIN Collection" />
    </div>

    <div class="controls">
      <div class="leftCtrls">
        <input id="q" placeholder="Search items..." />
      </div>
      <div class="leftCtrls" style="margin-top:-6px">
         <select id="filterStock">
          <option value="1">Available Only</option>
          <option value="0">Show All</option>
        </select>
        <button class="btn ghost" id="btnReload">↻</button>
      </div>
      <div class="rightCtrls" style="display:none">
        <div class="pill">API：<b id="apiText">-</b></div>
      </div>
    </div>

    <div id="grid" class="grid"></div>
  </div>

  <div class="toast" id="toast"></div>

  <div class="modalMask" id="mask">
    <div class="modal">
      <button class="xBtn" id="mClose">✕</button>
      <div class="modalL"><img id="mImg" alt="product" /></div>
      <div class="modalR">
        <div class="modalTop">
          <div>
            <h2 id="mTitle">-</h2>
            <div class="meta" id="mMeta"></div>
          </div>
        </div>

        <div class="desc" id="mDesc"></div>

        <div class="ytWrap" id="ytWrap">
          <iframe id="yt" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>
        </div>

        <div class="priceRow">
          <div class="price" id="mPrice"></div>
          <div class="miniBtns">
            <button class="miniBtn primary" id="mAdd">ADD TO BAG</button>
            <button class="miniBtn" id="mCheckout">BUY NOW</button>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
  /* --- 邏輯部分完全未修改 --- */
  const API = "https://api2.murain.tw";

  const $ = (id)=>document.getElementById(id);
  const toast = (msg)=>{
    const t = $("toast");
    t.textContent = msg;
    t.style.display = "block";
    clearTimeout(window.__toastTimer);
    window.__toastTimer = setTimeout(()=> t.style.display="none", 2200);
  };

  function getCartToken(){
    const sp = new URLSearchParams(location.search);
    let t = (sp.get("cart") || "").trim();
    if (t) localStorage.setItem("cart_token_b", t);
    t = localStorage.getItem("cart_token_b") || "";
    if (!t) {
      t = "b" + Math.random().toString(36).slice(2,10) + Date.now().toString(36).slice(2,6);
      localStorage.setItem("cart_token_b", t);
    }
    return t;
  }

  function money(n){
    try { return new Intl.NumberFormat("zh-TW").format(n||0); } catch { return String(n||0); }
  }

  function toYouTubeEmbed(url){
    if(!url) return "";
    const s = String(url).trim();
    if (s.includes("youtube.com/embed/")) return s;
    let m = s.match(/youtube\.com\/shorts\/([a-zA-Z0-9_-]{6,})/);
    if (m && m[1]) return "https://www.youtube.com/embed/" + m[1];
    m = s.match(/youtu\.be\/([a-zA-Z0-9_-]{6,})/);
    if (m && m[1]) return "https://www.youtube.com/embed/" + m[1];
    m = s.match(/[?&]v=([a-zA-Z0-9_-]{6,})/);
    if (m && m[1]) return "https://www.youtube.com/embed/" + m[1];
    return "";
  }

  const cartToken = getCartToken();
  $("tokenText").textContent = cartToken;
  $("apiText").textContent = API;

  $("btnCheckout").onclick = ()=> location.href = `./checkout.html?cart=${encodeURIComponent(cartToken)}`;
  $("btnReload").onclick = ()=> loadProducts();

  const state = { items: [], picked: null };
  async function loadProducts(){
    const inStock = $("filterStock").value === "1";
    const limit = 500; 
    const url = `${API}/public/products?limit=${limit}&in_stock=${inStock?1:0}`;

    $("grid").innerHTML = "";
    toast("Loading...");
    const res = await fetch(url, { method:"GET" });
    const data = await res.json().catch(()=> ({}));
    if(!res.ok || !data.ok){
      toast("Error: " + (data.message || data.error || res.status));
      return;
    }
    state.items = data.items || [];
    render();
    toast(`${state.items.length} items loaded`);
  }

  function matchQ(p, q){
    if(!q) return true;
    const s = q.toLowerCase();
    return [p.sku, p.name, p.brand].some(x => String(x||"").toLowerCase().includes(s));
  }

  function render(){
    const q = $("q").value.trim();
    const list = state.items.filter(p => matchQ(p, q));

    $("grid").innerHTML = list.map(p => {
      const img = p.image || "";
      const hasImg = !!img;
      const stock = Number(p.stock||0);
      /* HTML 結構微調以配合新 CSS：Badge 移到 imgbox 內，meta 暫時隱藏以求美觀 */
      return `
      <div class="card" onclick="openModal('${escapeAttr(p.sku||"")}')">
        <div class="imgbox">
          <div class="badge">${p.brand ? escapeHtml(p.brand) : escapeHtml(p.sku||"")}</div>
          ${hasImg ? `<img src="${escapeAttr(img)}" alt="img" loading="lazy" />` : `<div style="height:100%;display:flex;align-items:center;justify-content:center;color:#333;font-size:12px">NO IMAGE</div>`}
        </div>
        <div class="body">
          <div class="title">${escapeHtml(p.name || "")}</div>
          <div class="priceRow">
            <div class="price">$ ${money(p.price||0)}</div>
          </div>
        </div>
      </div>`;
    }).join("");
  }

  function escapeHtml(s){
    return String(s||"")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#39;");
  }
  function escapeAttr(s){ return escapeHtml(s); }

  window.openModal = (sku)=>{
    const p = state.items.find(x => String(x.sku||"") === String(sku||""));
    if(!p) return;

    state.picked = p;
    $("mTitle").textContent = p.name || "";
    $("mMeta").innerHTML = `
      <span>SKU：${escapeHtml(p.sku||"")}</span>
      <span>BRAND：${escapeHtml(p.brand||"")}</span>
      <span>STOCK：${Number(p.stock||0)}</span>
    `;
    $("mDesc").textContent = p.desc || "";

    const img = p.image || "";
    $("mImg").src = img || "";
    $("mImg").style.display = img ? "block" : "none";
    if(!img){
      $("mImg").alt = "no image";
      $("mImg").style.display = "block";
      $("mImg").src = "data:image/svg+xml;charset=utf-8," + encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="1200" height="800"><rect width="100%" height="100%" fill="#111"/><text x="50%" y="50%" fill="#333" font-size="48" font-family="Arial" text-anchor="middle">NO IMAGE</text></svg>`);
    }

    const embed = toYouTubeEmbed(p.youtube_embed || "");
    if(embed){
      $("yt").src = embed;
      $("ytWrap").style.display = "block";
    }else{
      $("yt").src = "";
      $("ytWrap").style.display = "none";
    }

    $("mPrice").textContent = "$ " + money(p.price||0);
    $("mask").style.display = "flex";
  };

  $("mClose").onclick = ()=> closeModal();
  $("mask").addEventListener("click", (e)=>{ if(e.target === $("mask")) closeModal(); });
  function closeModal(){
    $("mask").style.display = "none";
    $("yt").src = "";
  }

  window.addToCart = async (sku)=>{
    const p = state.items.find(x => String(x.sku||"") === String(sku||""));
    if(!p) return;
    const res = await fetch(`${API}/cart/add`, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ cart_token: cartToken, sku: p.sku, qty: 1 })
    });
    const data = await res.json().catch(()=> ({}));
    if(!res.ok || !data.ok){
      toast("Error：" + (data.message || data.error || res.status));
      return;
    }
    toast(`ADDED：${p.sku}`);
  };

  $("mAdd").onclick = ()=> {
    if(!state.picked) return;
    window.addToCart(state.picked.sku);
  };
  $("mCheckout").onclick = ()=> location.href = `./checkout.html?cart=${encodeURIComponent(cartToken)}`;

  $("q").addEventListener("input", ()=> render());

  loadProducts();
</script>
</body>
</html>
