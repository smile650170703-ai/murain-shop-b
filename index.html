<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>MURAIN 寄賣精品｜官方旗艦</title>
  <style>
    /* --- 核心變數：奢華黑金主題 --- */
    :root{
      --bg: #050505; /* 極致黑 */
      --surface: #141414;
      --surface-glass: rgba(20, 20, 20, 0.90);
      --gold: #D4AF37; /* 經典金 */
      --gold-light: #F2D266;
      --text: #ffffff;
      --text-sub: #9e9e9e;
      --line: rgba(255, 255, 255, 0.12);
      --shadow: 0 8px 32px rgba(0,0,0,0.6);
      /* 字體設定：中文使用黑體，英文標題使用襯線體 */
      --font-main: "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", sans-serif;
      --font-serif: "Times New Roman", serif; 
    }

    /* --- 基礎重置 --- */
    *{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
    body{
      margin: 0;
      font-family: var(--font-main);
      background-color: var(--bg);
      /* 背景紋理 */
      background-image: 
        radial-gradient(circle at 20% 0%, rgba(212, 175, 55, 0.08) 0%, transparent 40%),
        radial-gradient(circle at 80% 10%, rgba(255, 255, 255, 0.03) 0%, transparent 40%);
      color: var(--text);
      padding-bottom: 90px;
    }
    a{ color: inherit; text-decoration: none; }
    input, select, button { font-family: inherit; outline: none; }

    /* --- 版面容器 --- */
    .wrap{
      max-width: 600px; /* 手機版最佳寬度 */
      margin: 0 auto;
      padding: 0 16px;
    }

    /* --- 頂部導航 (毛玻璃效果) --- */
    .topbar {
      position: sticky;
      top: 0;
      z-index: 50;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 20px;
      margin: 0 -16px 20px -16px;
      background: var(--surface-glass);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border-bottom: 1px solid var(--line);
    }

    .brand h1 {
      margin: 0;
      font-family: var(--font-serif);
      font-size: 24px;
      font-weight: 400;
      letter-spacing: 1.5px;
      color: var(--gold);
      background: linear-gradient(45deg, var(--gold), var(--gold-light));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    .checkout-btn {
      font-size: 13px;
      font-weight: 500;
      color: var(--bg);
      background: var(--gold);
      padding: 8px 16px;
      border-radius: 99px;
      border: none;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(212, 175, 55, 0.3);
    }

    /* --- 純代碼繪製的「官網大圖」Banner --- */
    .hero-banner {
      margin: 0 -16px 28px -16px; /* 滿版 */
      height: 240px;
      position: relative;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      /* 黑金漸層背景 */
      background: linear-gradient(135deg, #0f0f12 0%, #1a1a20 100%);
      border-bottom: 1px solid var(--line);
    }
    /* 裝飾光影 */
    .hero-banner::before {
      content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
      background: radial-gradient(circle, rgba(212, 175, 55, 0.15) 0%, transparent 60%);
      animation: rotateLight 15s linear infinite;
    }
    @keyframes rotateLight { from {transform: rotate(0deg);} to {transform: rotate(360deg);} }
    
    .hero-content {
      position: relative; z-index: 2; text-align: center;
    }
    .hero-title {
      font-family: var(--font-serif);
      font-size: 36px;
      color: var(--gold);
      margin: 0 0 8px 0;
      letter-spacing: 2px;
      text-shadow: 0 4px 12px rgba(0,0,0,0.5);
    }
    .hero-sub {
      font-size: 12px;
      color: var(--text-sub);
      letter-spacing: 4px;
      text-transform: uppercase;
    }

    /* --- 篩選與搜尋列 --- */
    .controls {
      display: flex; flex-direction: column; gap: 12px; margin-bottom: 24px;
    }
    .search-row { display: flex; gap: 10px; }
    
    input, select {
      background: rgba(255,255,255,0.06);
      border: 1px solid var(--line);
      color: var(--text);
      border-radius: 12px;
      padding: 12px 16px;
      font-size: 14px;
      flex: 1;
      transition: border-color 0.3s;
    }
    input::placeholder { color: rgba(255,255,255,0.3); }
    input:focus, select:focus { border-color: var(--gold); }

    .btn-reload {
      width: 44px; display: flex; align-items: center; justify-content: center;
      background: transparent; border: 1px solid var(--line); color: var(--gold);
      border-radius: 12px; font-size: 18px;
    }

    /* --- 商品列表 (單欄大圖) --- */
    .grid {
      display: grid;
      grid-template-columns: 1fr; /* 手機版單欄 */
      gap: 36px;
    }
    @media(min-width: 600px){ .grid { grid-template-columns: 1fr 1fr; gap: 24px; } }

    /* --- 商品卡片 --- */
    .card {
      display: flex; flex-direction: column;
      cursor: pointer;
    }
    
    .imgbox {
      width: 100%;
      aspect-ratio: 4/5; /* 適合包包的比例 */
      background: #1a1a1a;
      border-radius: 16px;
      overflow: hidden;
      position: relative;
      border: 1px solid rgba(255,255,255,0.05);
      margin-bottom: 12px;
    }
    .imgbox img {
      width: 100%; height: 100%; object-fit: cover;
      transition: transform 0.5s ease;
    }
    /* 品牌標籤 */
    .badge-brand {
      position: absolute; left: 12px; top: 12px;
      background: rgba(0,0,0,0.6); backdrop-filter: blur(4px);
      padding: 6px 12px; border-radius: 6px;
      font-size: 11px; letter-spacing: 0.5px;
      border: 1px solid rgba(255,255,255,0.1);
    }
    .badge-stock {
      position: absolute; right: 12px; bottom: 12px;
      font-size: 10px; color: #fff; background: rgba(0,0,0,0.7);
      padding: 4px 8px; border-radius: 4px;
    }

    .info { padding: 0 4px; }
    .title {
      font-size: 16px; color: #eee; margin-bottom: 6px;
      line-height: 1.5;
      display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
    }
    .price-row {
      display: flex; justify-content: space-between; align-items: flex-end;
    }
    .price {
      font-family: var(--font-serif);
      font-size: 20px; color: var(--gold);
    }
    .more-btn {
      font-size: 12px; color: var(--text-sub);
      border-bottom: 1px solid var(--line);
    }

    /* --- Modal 詳情頁 (底部滑出) --- */
    .modal-mask {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.85);
      backdrop-filter: blur(5px);
      z-index: 100;
      display: none;
      align-items: flex-end; /* 手機版底部對齊 */
      justify-content: center;
    }
    .modal-content {
      width: 100%; max-width: 500px;
      background: #18181b;
      border-radius: 24px 24px 0 0;
      border-top: 1px solid var(--line);
      max-height: 85vh;
      overflow-y: auto;
      display: flex; flex-direction: column;
      position: relative;
      animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    }
    @keyframes slideUp { from {transform: translateY(100%);} to {transform: translateY(0);} }

    .modal-img {
      width: 100%; height: 350px;
      background: #000;
      object-fit: contain;
    }
    .close-btn {
      position: absolute; top: 16px; right: 16px;
      width: 36px; height: 36px; border-radius: 50%;
      background: rgba(0,0,0,0.5); border: none; color: #fff;
      font-size: 20px; z-index: 10;
    }

    .modal-body { padding: 24px; display: flex; flex-direction: column; gap: 16px; }
    .modal-title { font-size: 20px; margin: 0; line-height: 1.4; font-weight: 500; }
    
    .data-grid {
      display: grid; grid-template-columns: 1fr 1fr; gap: 12px;
      background: rgba(255,255,255,0.03);
      padding: 16px; border-radius: 12px;
      font-size: 13px; color: var(--text-sub);
    }
    .data-grid b { color: var(--text); display: block; margin-bottom: 4px; font-size: 14px; }

    .desc-text {
      font-size: 14px; line-height: 1.8; color: #ccc;
      white-space: pre-wrap; margin-bottom: 10px;
    }

    .action-bar {
      margin-top: auto; padding-top: 10px;
      display: flex; gap: 12px;
    }
    .btn-action {
      flex: 1; padding: 14px; border-radius: 12px;
      font-weight: 600; font-size: 14px; border: none; cursor: pointer;
    }
    .btn-cart { background: rgba(255,255,255,0.1); color: #fff; }
    .btn-buy { background: var(--gold); color: #000; }

    /* Toast */
    .toast {
      position: fixed; left: 50%; bottom: 30px; transform: translateX(-50%);
      background: #fff; color: #000; padding: 10px 20px;
      border-radius: 99px; font-size: 14px; font-weight: 600;
      box-shadow: 0 5px 20px rgba(0,0,0,0.5);
      display: none; z-index: 200; white-space: nowrap;
    }

    .ytWrap { width: 100%; aspect-ratio: 16/9; background: #000; border-radius: 12px; overflow: hidden; margin-top: 10px; display: none; }
    .ytWrap iframe { width: 100%; height: 100%; border: none; }
  </style>
</head>
<body>

  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <h1>MURAIN</h1>
      </div>
      <div style="display:flex; gap:10px;">
        <div style="display:none">Token: <span id="tokenText"></span></div>
        <button class="checkout-btn" id="btnCheckout">前往結帳</button>
      </div>
    </div>

    <div class="hero-banner">
      <div class="hero-content">
        <div class="hero-title">MURAIN</div>
        <div class="hero-sub">LUXURY CONSIGNMENT</div>
      </div>
    </div>

    <div class="controls">
      <div class="search-row">
        <input id="q" placeholder="搜尋品牌、名稱或 SKU..." />
        <button class="btn-reload" id="btnReload">↻</button>
      </div>
      <div class="search-row">
        <select id="filterStock">
          <option value="1">僅顯示有庫存商品</option>
          <option value="0">顯示全部商品 (含已售完)</option>
        </select>
        <span id="apiText" style="display:none"></span>
      </div>
    </div>

    <div id="grid" class="grid"></div>
  </div>

  <div class="toast" id="toast"></div>

  <div class="modal-mask" id="mask">
    <div class="modal-content">
      <button class="close-btn" id="mClose">✕</button>
      <img id="mImg" class="modal-img" alt="product" />
      
      <div class="modal-body">
        <div>
          <h2 class="modal-title" id="mTitle"></h2>
          <div style="color:var(--gold); font-family:var(--font-serif); font-size:24px; margin-top:8px;">
            <span id="mPrice"></span>
          </div>
        </div>

        <div class="data-grid" id="mMeta"></div>

        <div class="desc-text" id="mDesc"></div>

        <div class="ytWrap" id="ytWrap">
          <iframe id="yt" allow="autoplay; encrypted-media" allowfullscreen></iframe>
        </div>

        <div class="action-bar">
          <button class="btn-action btn-cart" id="mAdd">加入購物車</button>
          <button class="btn-action btn-buy" id="mCheckout">立即結帳</button>
        </div>
      </div>
    </div>
  </div>

<script>
  /* --- 核心邏輯保持不變，僅微調文字顯示 --- */
  const API = "https://api2.murain.tw";
  const $ = (id)=>document.getElementById(id);
  
  const toast = (msg)=>{
    const t = $("toast");
    t.textContent = msg;
    t.style.display = "block";
    clearTimeout(window.__toastTimer);
    window.__toastTimer = setTimeout(()=> t.style.display="none", 2000);
  };

  function getCartToken(){
    const sp = new URLSearchParams(location.search);
    let t = (sp.get("cart") || "").trim();
    if (t) localStorage.setItem("cart_token_b", t);
    t = localStorage.getItem("cart_token_b") || "";
    if (!t) {
      t = "b" + Math.random().toString(36).slice(2,10) + Date.now().toString(36).slice(2,6);
      localStorage.setItem("cart_token_b", t);
    }
    return t;
  }

  function money(n){
    try { return new Intl.NumberFormat("zh-TW").format(n||0); } catch { return String(n||0); }
  }

  function toYouTubeEmbed(url){
    if(!url) return "";
    const s = String(url).trim();
    if (s.includes("youtube.com/embed/")) return s;
    let m = s.match(/youtube\.com\/shorts\/([a-zA-Z0-9_-]{6,})/);
    if (m && m[1]) return "https://www.youtube.com/embed/" + m[1];
    m = s.match(/youtu\.be\/([a-zA-Z0-9_-]{6,})/);
    if (m && m[1]) return "https://www.youtube.com/embed/" + m[1];
    m = s.match(/[?&]v=([a-zA-Z0-9_-]{6,})/);
    if (m && m[1]) return "https://www.youtube.com/embed/" + m[1];
    return "";
  }

  const cartToken = getCartToken();
  $("tokenText").textContent = cartToken;
  $("apiText").textContent = API;

  $("btnCheckout").onclick = ()=> location.href = `./checkout.html?cart=${encodeURIComponent(cartToken)}`;
  $("btnReload").onclick = ()=> loadProducts();

  const state = { items: [], picked: null };

  async function loadProducts(){
    const inStock = $("filterStock").value === "1";
    const url = `${API}/public/products?limit=500&in_stock=${inStock?1:0}`;

    $("grid").innerHTML = "";
    toast("商品載入中...");
    
    const res = await fetch(url, { method:"GET" });
    const data = await res.json().catch(()=> ({}));
    
    if(!res.ok || !data.ok){
      toast("載入失敗：" + (data.message || data.error));
      return;
    }
    state.items = data.items || [];
    render();
    toast(`已更新 ${state.items.length} 件商品`);
  }

  function matchQ(p, q){
    if(!q) return true;
    const s = q.toLowerCase();
    return [p.sku, p.name, p.brand].some(x => String(x||"").toLowerCase().includes(s));
  }

  function render(){
    const q = $("q").value.trim();
    const list = state.items.filter(p => matchQ(p, q));

    $("grid").innerHTML = list.map(p => {
      const img = p.image || "";
      const hasImg = !!img;
      const stock = Number(p.stock||0);
      
      /* 卡片 HTML 結構 */
      return `
      <div class="card" onclick="openModal('${escapeAttr(p.sku||"")}')">
        <div class="imgbox">
          <div class="badge-brand">${p.brand ? escapeHtml(p.brand) : "MURAIN"}</div>
          ${stock > 0 ? '' : '<div class="badge-stock" style="background:rgba(200,50,50,0.8)">已售完</div>'}
          ${hasImg 
            ? `<img src="${escapeAttr(img)}" alt="img" loading="lazy" />` 
            : `<div style="height:100%;display:flex;align-items:center;justify-content:center;color:#444;font-size:12px">暫無圖片</div>`
          }
        </div>
        <div class="info">
          <div class="title">${escapeHtml(p.name || "")}</div>
          <div class="price-row">
            <div class="price">$ ${money(p.price||0)}</div>
            <div class="more-btn">查看詳情</div>
          </div>
        </div>
      </div>`;
    }).join("");
  }

  function escapeHtml(s){
    return String(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");
  }
  function escapeAttr(s){ return escapeHtml(s); }

  window.openModal = (sku)=>{
    const p = state.items.find(x => String(x.sku||"") === String(sku||""));
    if(!p) return;

    state.picked = p;
    $("mTitle").textContent = p.name || "";
    $("mPrice").textContent = "$ " + money(p.price||0);
    
    $("mMeta").innerHTML = `
      <div><b>品牌</b>${escapeHtml(p.brand||"-")}</div>
      <div><b>SKU</b>${escapeHtml(p.sku||"-")}</div>
      <div><b>庫存</b>${Number(p.stock||0)}</div>
    `;
    $("mDesc").textContent = p.desc || "";

    const img = p.image || "";
    $("mImg").src = img || "";
    $("mImg").style.display = img ? "block" : "none";
    
    if(!img){
       $("mImg").style.display = "block";
       $("mImg").src = "data:image/svg+xml;charset=utf-8," + encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="800" height="800" style="background:#111"><text x="50%" y="50%" fill="#333" font-size="24" font-family="sans-serif" text-anchor="middle" dy=".3em">NO IMAGE</text></svg>`);
    }

    const embed = toYouTubeEmbed(p.youtube_embed || "");
    if(embed){
      $("yt").src = embed;
      $("ytWrap").style.display = "block";
    }else{
      $("yt").src = "";
      $("ytWrap").style.display = "none";
    }

    $("mask").style.display = "flex";
  };

  $("mClose").onclick = ()=> closeModal();
  $("mask").addEventListener("click", (e)=>{ if(e.target === $("mask")) closeModal(); });
  function closeModal(){
    $("mask").style.display = "none";
    $("yt").src = "";
  }

  window.addToCart = async (sku)=>{
    const p = state.items.find(x => String(x.sku||"") === String(sku||""));
    if(!p) return;
    
    const res = await fetch(`${API}/cart/add`, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ cart_token: cartToken, sku: p.sku, qty: 1 })
    });
    const data = await res.json().catch(()=> ({}));
    
    if(!res.ok || !data.ok){
      toast("加入失敗：" + (data.message || data.error));
      return;
    }
    toast(`已加入購物車`);
    closeModal();
  };

  $("mAdd").onclick = ()=> {
    if(!state.picked) return;
    window.addToCart(state.picked.sku);
  };
  $("mCheckout").onclick = ()=> location.href = `./checkout.html?cart=${encodeURIComponent(cartToken)}`;

  $("q").addEventListener("input", ()=> render());
  $("filterStock").addEventListener("change", ()=> loadProducts());

  loadProducts();
</script>
</body>
</html>
