<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MURAIN 寄賣精品｜官網 B</title>
  <meta name="robots" content="noindex,nofollow" />
  <style>
    :root{
      --bg:#07060a;
      --card:#0f0e14;
      --card2:#12111a;
      --gold:#c9a24a;
      --gold2:#f2d27a;
      --text:#f2f2f2;
      --muted:#b7b7b7;
      --line:rgba(201,162,74,.28);
      --shadow: 0 12px 40px rgba(0,0,0,.55);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Noto Sans TC", Segoe UI, Arial;
      background:
        radial-gradient(1200px 600px at 20% 10%, rgba(201,162,74,.12), transparent 55%),
        radial-gradient(900px 500px at 80% 0%, rgba(242,210,122,.10), transparent 60%),
        var(--bg);
      color:var(--text);
    }
    a{color:inherit}
    .wrap{max-width:1180px;margin:0 auto;padding:26px 18px 60px;}
    .top{
      display:flex;gap:14px;align-items:stretch;flex-wrap:wrap;
    }
    .banner{
      flex: 1 1 520px;
      border:1px solid var(--line);
      border-radius: var(--radius);
      overflow:hidden;
      box-shadow: var(--shadow);
      background: linear-gradient(180deg, rgba(0,0,0,.35), rgba(0,0,0,.75));
      position:relative;
      min-height:170px;
    }
    .banner::before{
      content:"";
      position:absolute;inset:0;
      background-image: url("./assets/murain-banner.png");
      background-size: cover;
      background-position: center;
      filter: saturate(1.05) contrast(1.05);
      opacity:.92;
    }
    .banner::after{
      content:"";
      position:absolute;inset:0;
      background: radial-gradient(800px 250px at 30% 35%, rgba(0,0,0,.05), rgba(0,0,0,.82));
    }
    .bannerInner{
      position:relative;
      padding:20px 22px;
      display:flex;flex-direction:column;gap:10px;
    }
    .brand{
      display:flex;align-items:flex-end;gap:10px;flex-wrap:wrap;
    }
    .brand h1{margin:0;font-size:26px;letter-spacing:.6px}
    .pill{
      display:inline-flex;gap:8px;align-items:center;
      border:1px solid var(--line);
      padding:6px 10px;border-radius:999px;
      color:var(--gold2);
      background: rgba(0,0,0,.35);
      font-size:13px;
    }

    .panel{
      flex: 0 0 360px;
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(18,17,26,.92), rgba(10,10,14,.92));
      box-shadow: var(--shadow);
      padding:14px 14px 12px;
      display:flex;flex-direction:column;gap:10px;
      min-width:280px;
    }
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .k{color:var(--muted);font-size:12px}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
    .btn{
      cursor:pointer;
      border:1px solid var(--line);
      background: radial-gradient(120px 60px at 30% 30%, rgba(242,210,122,.16), rgba(201,162,74,.10));
      color:var(--text);
      padding:10px 12px;
      border-radius: 12px;
      font-weight:700;
      letter-spacing:.2px;
    }
    .btn:hover{border-color: rgba(242,210,122,.55)}
    .btnGhost{
      cursor:pointer;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.25);
      color:var(--text);
      padding:10px 12px;
      border-radius: 12px;
      font-weight:700;
    }
    .btnSmall{padding:8px 10px;border-radius:10px;font-weight:700;font-size:13px}
    .input, .select{
      width:100%;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.25);
      color:var(--text);
      padding:10px 12px;
      border-radius: 12px;
      outline:none;
    }
    .gridHead{
      margin-top:18px;
      display:flex;gap:10px;align-items:center;flex-wrap:wrap;
      justify-content:space-between;
    }
    .title2{font-size:18px;margin:0}
    .filters{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .grid{
      margin-top:12px;
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:12px;
    }
    @media (max-width: 980px){ .grid{grid-template-columns: repeat(2, minmax(0, 1fr));} }
    @media (max-width: 560px){ .grid{grid-template-columns: 1fr;} }

    .card{
      border:1px solid var(--line);
      border-radius: var(--radius);
      overflow:hidden;
      background: linear-gradient(180deg, rgba(18,17,26,.92), rgba(10,10,14,.92));
      box-shadow: var(--shadow);
      display:flex;flex-direction:column;
      min-height: 320px;
    }
    .img{
      height:190px;
      background: rgba(0,0,0,.35);
      border-bottom:1px solid rgba(201,162,74,.22);
      display:flex;align-items:center;justify-content:center;
      overflow:hidden;
    }
    .img img{width:100%;height:100%;object-fit:cover;display:block}
    .img .ph{color:rgba(255,255,255,.35);font-size:12px}
    .body{padding:12px 12px 12px;display:flex;flex-direction:column;gap:8px;flex:1}
    .name{font-weight:900;font-size:15px;line-height:1.3}
    .meta{display:flex;gap:10px;flex-wrap:wrap;color:var(--muted);font-size:12px}
    .priceRow{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-top:auto}
    .price{font-weight:900;font-size:18px;color:var(--gold2)}
    .tag{
      font-size:12px;
      border:1px solid rgba(255,255,255,.12);
      padding:4px 8px;border-radius:999px;
      color:rgba(255,255,255,.86);
      background: rgba(0,0,0,.18);
    }
    .tagGold{border-color: rgba(201,162,74,.45); color: var(--gold2);}

    /* modal */
    .modalMask{position:fixed;inset:0;background:rgba(0,0,0,.66);display:none;align-items:center;justify-content:center;padding:16px;z-index:99}
    .modal{
      width:min(980px, 100%);
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(18,17,26,.96), rgba(10,10,14,.96));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modalTop{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:12px 14px;border-bottom:1px solid rgba(201,162,74,.22)}
    .modalTop b{font-size:15px}
    .modalBody{display:grid;grid-template-columns: 1.1fr .9fr;gap:0}
    @media (max-width: 900px){ .modalBody{grid-template-columns: 1fr;} }
    .modalImg{min-height:360px;background:#0b0a10;border-right:1px solid rgba(201,162,74,.22)}
    @media (max-width: 900px){ .modalImg{border-right:0;border-bottom:1px solid rgba(201,162,74,.22)} }
    .modalImg img{width:100%;height:100%;object-fit:cover;display:block}
    .modalRight{padding:14px}
    .desc{white-space:pre-wrap;color:rgba(255,255,255,.86);font-size:13px;line-height:1.6}
    .ytWrap{margin-top:12px;border:1px solid rgba(255,255,255,.12);border-radius:14px;overflow:hidden;background:#000}
    .ytWrap iframe{width:100%;aspect-ratio: 16/9;border:0;display:block}
    .toast{position:fixed;left:50%;bottom:22px;transform:translateX(-50%);background:rgba(0,0,0,.75);border:1px solid rgba(201,162,74,.35);color:var(--text);padding:10px 12px;border-radius:999px;display:none;z-index:999}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="banner">
        <div class="bannerInner">
          <div class="brand">
            <h1>MURAIN 寄賣精品</h1>
            <span class="pill">官網 B・正式上線版</span>
          </div>
          <div class="row">
            <span class="pill"><span class="k">API</span> <span class="mono" id="apiText"></span></span>
            <span class="pill"><span class="k">LINE 登入</span> <span class="mono" id="lineState">未初始化</span></span>
          </div>
        </div>
      </div>

      <div class="panel">
        <div class="row" style="justify-content:space-between">
          <div>
            <div class="k">cart_token</div>
            <div class="mono" id="tokenText" style="font-weight:900;font-size:15px"></div>
          </div>
          <button class="btnSmall btnGhost" id="btnReset">換一個</button>
        </div>

        <div class="row" style="gap:8px">
          <button class="btn" id="btnCheckout" style="flex:1">前往結帳</button>
          <button class="btnSmall btnGhost" id="btnReload">重載商品</button>
        </div>

        <div class="row">
          <select class="select" id="stockFilter" style="flex:1;min-width:140px">
            <option value="1">只看有庫存</option>
            <option value="0">全部（含 0 庫存）</option>
          </select>
          <input class="input" id="q" placeholder="搜尋 SKU / 名稱 / 品牌" style="flex:1;min-width:180px" />
        </div>

        <div class="k" id="msg" style="min-height:18px"></div>
      </div>
    </div>

    <div class="gridHead">
      <h2 class="title2">商品列表</h2>
      <div class="filters">
        <span class="k">提示：照片用 Images(附件) 上傳；影片用 youtube_embed 放 embed 連結</span>
      </div>
    </div>

    <div class="grid" id="grid"></div>
  </div>

  <!-- Modal -->
  <div class="modalMask" id="mask">
    <div class="modal">
      <div class="modalTop">
        <b id="mTitle">商品詳情</b>
        <div class="row">
          <button class="btnSmall btn" id="mAdd">加入購物車</button>
          <button class="btnSmall btnGhost" id="mClose">關閉</button>
        </div>
      </div>
      <div class="modalBody">
        <div class="modalImg" id="mImg"></div>
        <div class="modalRight">
          <div class="meta" id="mMeta"></div>
          <div class="desc" id="mDesc"></div>
          <div class="ytWrap" id="mYtWrap" style="display:none"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <!-- LIFF (如果你要「一定要 LINE 登入才能買」，就設定 LIFF_ID) -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
    // ====== 設定區（只改這裡）======
    const API_DEFAULT = "https://api2.murain.tw";
    const LIFF_ID = ""; // 例如 "200xxxxx-xxxxxxxx"；空字串=不強制（你正式要強制就填上）
    const BANNER_PATH = "./assets/murain-banner.png";
    // ===============================

    const API = new URL(location.href).searchParams.get("api") || API_DEFAULT;
    document.getElementById("apiText").textContent = API;

    // token
    const LS_TOKEN = "murain_b_cart_token";
    function genToken(){
      const s = Math.random().toString(36).slice(2, 6) + Date.now().toString(36).slice(-4);
      return "b" + s;
    }
    function getToken(){
      let t = localStorage.getItem(LS_TOKEN);
      if (!t){ t = genToken(); localStorage.setItem(LS_TOKEN, t); }
      return t;
    }
    function setToken(t){
      localStorage.setItem(LS_TOKEN, t);
      document.getElementById("tokenText").textContent = t;
    }
    setToken(getToken());

    // LINE login (optional)
    let LINE = { ok:false, userId:"", idToken:"", name:"" };
    async function initLINE(){
      const el = document.getElementById("lineState");
      if (!LIFF_ID){
        el.textContent = "未啟用（未填 LIFF_ID）";
        return;
      }
      try{
        await liff.init({ liffId: LIFF_ID });
        if (!liff.isLoggedIn()) liff.login();
        const prof = await liff.getProfile();
        LINE.ok = true;
        LINE.userId = prof.userId || "";
        LINE.name = prof.displayName || "";
        LINE.idToken = liff.getIDToken() || "";
        el.textContent = "已登入";
      }catch(e){
        el.textContent = "初始化失敗";
      }
    }
    initLINE();

    // UI actions
    document.getElementById("btnReset").onclick = ()=>{
      setToken(genToken());
      toast("已更換 cart_token");
    };
    document.getElementById("btnCheckout").onclick = ()=>{
      const t = getToken();
      location.href = `./checkout.html?cart=${encodeURIComponent(t)}`;
    };
    document.getElementById("btnReload").onclick = ()=> load();
    document.getElementById("q").addEventListener("input", ()=> render());
    document.getElementById("stockFilter").addEventListener("change", ()=> load());

    // data
    let ALL = [];
    const grid = document.getElementById("grid");
    const msg = document.getElementById("msg");

    function money(n){
      try{ return new Intl.NumberFormat("zh-TW").format(Number(n||0)); }catch{ return String(n||0); }
    }
    function toast(t){
      const el = document.getElementById("toast");
      el.textContent = t;
      el.style.display = "block";
      clearTimeout(el._t);
      el._t = setTimeout(()=> el.style.display="none", 1800);
    }

    async function apiGet(u){
      const res = await fetch(u, { method:"GET" });
      const j = await res.json().catch(()=>null);
      if (!res.ok) throw new Error(j?.message || j?.error || "fetch_failed");
      return j;
    }
    async function apiPost(u, data){
      const res = await fetch(u, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(data||{})
      });
      const j = await res.json().catch(()=>null);
      if (!res.ok) throw new Error(j?.message || j?.error || "post_failed");
      return j;
    }

    async function load(){
      msg.textContent = "載入中…";
      grid.innerHTML = "";
      const inStock = document.getElementById("stockFilter").value === "1" ? "1" : "0";
      const url = `${API}/public/products?limit=2000&in_stock=${inStock}`;
      try{
        const data = await apiGet(url);
        ALL = Array.isArray(data.items) ? data.items : [];
        msg.textContent = `已載入 ${ALL.length} 件商品`;
        render();
      }catch(e){
        msg.textContent = "載入失敗：" + (e?.message || "error");
      }
    }

    function render(){
      const q = (document.getElementById("q").value || "").trim().toLowerCase();
      const list = ALL.filter(x=>{
        if (!q) return true;
        const s = `${x.sku||""} ${x.name||""} ${x.brand||""}`.toLowerCase();
        return s.includes(q);
      });

      grid.innerHTML = list.map(p=>{
        const img = p.image ? `<img src="${p.image}" alt="product" loading="lazy" />` : `<div class="ph">No Image</div>`;
        const stockTag = (Number(p.stock||0) > 0) ? `<span class="tag tagGold">庫存 ${p.stock}</span>` : `<span class="tag">缺貨</span>`;
        const brandTag = p.brand ? `<span class="tag">${p.brand}</span>` : ``;
        return `
          <div class="card">
            <div class="img">${img}</div>
            <div class="body">
              <div class="name">${escapeHtml(p.name||"")}</div>
              <div class="meta">
                <span class="tag">SKU ${escapeHtml(p.sku||"")}</span>
                ${brandTag}
                ${stockTag}
              </div>
              <div class="priceRow">
                <div class="price">$ ${money(p.price)}</div>
                <div class="row" style="gap:8px">
                  <button class="btnSmall btnGhost" onclick="openModal('${escapeAttr(p.sku||"")}')">詳情</button>
                  <button class="btnSmall btn" onclick="addToCart('${escapeAttr(p.sku||"")}', 1)">加入購物車</button>
                </div>
              </div>
            </div>
          </div>
        `;
      }).join("") || `<div class="k">沒有符合的商品</div>`;
    }

    // modal
    const mask = document.getElementById("mask");
    const mTitle = document.getElementById("mTitle");
    const mImg = document.getElementById("mImg");
    const mMeta = document.getElementById("mMeta");
    const mDesc = document.getElementById("mDesc");
    const mYtWrap = document.getElementById("mYtWrap");
    const mAdd = document.getElementById("mAdd");
    document.getElementById("mClose").onclick = ()=> mask.style.display="none";
    mask.addEventListener("click", (e)=>{ if (e.target === mask) mask.style.display="none"; });

    function openModal(sku){
      const p = ALL.find(x=>String(x.sku||"")===String(sku));
      if (!p) return;
      mTitle.textContent = p.name || "商品詳情";
      mImg.innerHTML = p.image ? `<img src="${p.image}" alt="product" />` : `<div style="padding:18px;color:rgba(255,255,255,.35)">No Image</div>`;
      mMeta.innerHTML = `
        <span class="tag">SKU ${escapeHtml(p.sku||"")}</span>
        ${p.brand ? `<span class="tag">${escapeHtml(p.brand)}</span>` : ``}
        <span class="tag tagGold">價格 $ ${money(p.price)}</span>
        <span class="tag">${Number(p.stock||0)>0 ? `庫存 ${p.stock}` : `缺貨`}</span>
      `;
      mDesc.textContent = p.desc || "";
      mYtWrap.style.display = "none";
      mYtWrap.innerHTML = "";

      // youtube_embed 必須是 embed 連結，例如 https://www.youtube.com/embed/VIDEOID
      if (p.youtube_embed && String(p.youtube_embed).includes("youtube.com/embed/")){
        mYtWrap.style.display = "block";
        mYtWrap.innerHTML = `<iframe src="${p.youtube_embed}" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`;
      }

      mAdd.onclick = ()=> addToCart(p.sku, 1);
      mask.style.display = "flex";
    }

    // cart
    async function addToCart(sku, qty){
      // 如果你正式要求「一定要 LINE 登入才能買」：這裡就強制檢查
      if (LIFF_ID && !LINE.ok){
        toast("請先完成 LINE 登入");
        return;
      }

      const cart_token = getToken();
      try{
        await apiPost(`${API}/cart/add`, {
          cart_token,
          sku,
          qty,
          line_user_id: LINE.userId || "",
          customer_name: LINE.name || ""
        });
        toast("已加入購物車");
      }catch(e){
        toast("加入失敗：" + (e?.message || "error"));
      }
    }

    // utils
    function escapeHtml(s){
      return String(s||"")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function escapeAttr(s){ return escapeHtml(s).replaceAll("`",""); }

    load();
    window.openModal = openModal;
    window.addToCart = addToCart;
  </script>
</body>
</html>
