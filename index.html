<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MURAIN 寄賣精品｜官網 B</title>
  <style>
    :root{
      --bg:#07070a;
      --card:#0e0f14;
      --card2:#0b0c10;
      --gold:#d6b25e;
      --gold2:#b8933f;
      --text:#f4f1e8;
      --muted:#b8b2a5;
      --line:rgba(214,178,94,.28);
      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", Arial, sans-serif;
      background: radial-gradient(1200px 600px at 20% 0%, rgba(214,178,94,.08), transparent 55%),
                  radial-gradient(900px 500px at 85% 10%, rgba(214,178,94,.06), transparent 55%),
                  linear-gradient(180deg, #05050a 0%, #07070a 40%, #05050a 100%);
      color:var(--text);
    }
    a{color:inherit}
    .wrap{max-width:1200px;margin:0 auto;padding:24px 16px 56px}
    .topbar{
      display:flex;gap:12px;align-items:center;justify-content:space-between;
      margin-bottom:14px;
    }
    .brand{
      display:flex;flex-direction:column;gap:4px;
    }
    .brand h1{margin:0;font-size:18px;letter-spacing:.6px}
    .brand .sub{color:var(--muted);font-size:12px}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:10px 12px;border:1px solid var(--line);
      border-radius:999px;background:rgba(0,0,0,.35);
      box-shadow: var(--shadow);
      font-size:12px;color:var(--muted);
      max-width:100%;
      overflow:hidden;
    }
    .pill b{color:var(--text);font-weight:700}
    .btn{
      appearance:none;border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(214,178,94,.16), rgba(0,0,0,.35));
      color:var(--text);padding:10px 14px;border-radius:999px;
      cursor:pointer;font-weight:700;
    }
    .btn:active{transform:translateY(1px)}
    .btn.ghost{
      background:transparent;
    }
    .banner{
      border:1px solid var(--line);
      border-radius:var(--radius);
      background:rgba(0,0,0,.35);
      overflow:hidden;
      box-shadow: var(--shadow);
    }
    .banner img{display:block;width:100%;height:auto}
    .controls{
      margin-top:14px;
      display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between;
    }
    .leftCtrls{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .rightCtrls{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    select,input{
      background:rgba(0,0,0,.38);
      border:1px solid var(--line);
      color:var(--text);
      border-radius:999px;
      padding:10px 12px;
      outline:none;
      min-height:40px;
    }
    input{min-width:240px}
    .grid{
      margin-top:14px;
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:14px;
    }
    @media (max-width:1100px){ .grid{grid-template-columns: repeat(3, 1fr);} }
    @media (max-width:820px){ .grid{grid-template-columns: repeat(2, 1fr);} input{min-width:180px} }
    @media (max-width:520px){ .grid{grid-template-columns: 1fr;} }
    .card{
      border:1px solid var(--line);
      border-radius:var(--radius);
      background:linear-gradient(180deg, rgba(214,178,94,.08), rgba(0,0,0,.35));
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex;flex-direction:column;
      min-height: 420px;
    }
    .imgbox{
      position:relative;
      background:rgba(0,0,0,.35);
      border-bottom:1px solid var(--line);
      height: 220px;
      display:flex;align-items:center;justify-content:center;
    }
    .imgbox img{
      width:100%;height:100%;
      object-fit:cover;
      display:block;
    }
    .badge{
      position:absolute;left:10px;top:10px;
      font-size:12px;
      padding:6px 10px;border-radius:999px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.5);
      color:var(--muted);
    }
    .body{padding:12px 12px 14px;display:flex;flex-direction:column;gap:8px;flex:1}
    .title{font-weight:900;letter-spacing:.3px}
    .meta{color:var(--muted);font-size:12px;display:flex;gap:10px;flex-wrap:wrap}
    .priceRow{display:flex;align-items:center;justify-content:space-between;margin-top:auto;gap:10px}
    .price{font-size:16px;font-weight:900;color:var(--gold)}
    .miniBtns{display:flex;gap:8px;flex-wrap:wrap}
    .miniBtn{
      border:1px solid var(--line);
      background:rgba(0,0,0,.35);
      color:var(--text);
      padding:9px 10px;border-radius:999px;
      cursor:pointer;font-weight:800;font-size:12px;
      white-space:nowrap;
    }
    .miniBtn.primary{
      background:linear-gradient(180deg, rgba(214,178,94,.25), rgba(0,0,0,.35));
    }
    .toast{
      position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
      background:rgba(0,0,0,.75);border:1px solid var(--line);color:var(--text);
      padding:10px 12px;border-radius:999px;box-shadow: var(--shadow);
      font-size:13px;display:none;z-index:50;
      max-width: calc(100vw - 24px);
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }
    .modalMask{
      position:fixed;inset:0;background:rgba(0,0,0,.72);
      display:none;align-items:center;justify-content:center;z-index:60;
      padding:16px;
    }
    .modal{
      width:min(980px, 100%);
      border:1px solid var(--line);
      border-radius:var(--radius);
      background:linear-gradient(180deg, rgba(214,178,94,.10), rgba(0,0,0,.65));
      box-shadow: var(--shadow);
      overflow:hidden;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:0;
    }
    @media (max-width:860px){ .modal{grid-template-columns:1fr;} }
    .modalL{
      background:rgba(0,0,0,.35);
      border-right:1px solid var(--line);
      display:flex;align-items:center;justify-content:center;
      min-height:320px;
    }
    .modalL img{width:100%;height:100%;object-fit:cover;display:block}
    .modalR{padding:14px 14px 16px;display:flex;flex-direction:column;gap:10px}
    .modalTop{display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
    .modalTop h2{margin:0;font-size:18px}
    .xBtn{
      border:1px solid var(--line);
      background:rgba(0,0,0,.35);
      color:var(--text);
      width:36px;height:36px;border-radius:10px;
      cursor:pointer;font-weight:900;
    }
    .desc{color:var(--muted);font-size:13px;line-height:1.6;white-space:pre-wrap}
    .ytWrap{
      border:1px solid var(--line);
      border-radius:14px;
      overflow:hidden;
      background:#000;
      aspect-ratio: 16/9;
      display:none;
    }
    .ytWrap iframe{width:100%;height:100%;border:0}
    .footRow{display:flex;gap:8px;flex-wrap:wrap;margin-top:auto}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <h1>MURAIN 寄賣精品｜官網 B</h1>
        <div class="sub">圖片用 <b>Products.Images（附件）</b> 或 <b>Products.Image（網址）</b>；影片用 <b>youtube_embed（embed 連結）</b></div>
      </div>
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-end">
        <div class="pill" title="購物車 token（系統自動產生/可帶參數覆蓋）">
          cart_token：<b id="tokenText">-</b>
        </div>
        <button class="btn" id="btnCheckout">前往結帳</button>
      </div>
    </div>

    <div class="banner">
      <!-- 把你的那張 MURAIN 寄賣圖存成 banner.png 丟在同一層 -->
      <img src="./banner.png" alt="MURAIN 寄賣 Banner" />
    </div>

    <div class="controls">
      <div class="leftCtrls">
        <select id="filterStock">
          <option value="1">僅顯示有庫存</option>
          <option value="0">顯示全部（含 0 庫存）</option>
        </select>
        <input id="q" placeholder="搜尋 SKU / 名稱 / 品牌" />
        <button class="btn ghost" id="btnReload">重新載入商品</button>
      </div>
      <div class="rightCtrls">
        <div class="pill" title="API 位址">
          API：<b id="apiText">-</b>
        </div>
      </div>
    </div>

    <div id="grid" class="grid"></div>
  </div>

  <div class="toast" id="toast"></div>

  <div class="modalMask" id="mask">
    <div class="modal">
      <div class="modalL"><img id="mImg" alt="product" /></div>
      <div class="modalR">
        <div class="modalTop">
          <div>
            <h2 id="mTitle">-</h2>
            <div class="meta" id="mMeta"></div>
          </div>
          <button class="xBtn" id="mClose">✕</button>
        </div>

        <div class="desc" id="mDesc"></div>

        <div class="ytWrap" id="ytWrap">
          <iframe id="yt" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>
        </div>

        <div class="priceRow">
          <div class="price" id="mPrice"></div>
          <div class="miniBtns">
            <button class="miniBtn primary" id="mAdd">加入購物車</button>
            <button class="miniBtn" id="mCheckout">前往結帳</button>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
  const API = "https://api2.murain.tw";

  const $ = (id)=>document.getElementById(id);
  const toast = (msg)=>{
    const t = $("toast");
    t.textContent = msg;
    t.style.display = "block";
    clearTimeout(window.__toastTimer);
    window.__toastTimer = setTimeout(()=> t.style.display="none", 2200);
  };

  function getCartToken(){
    const sp = new URLSearchParams(location.search);
    let t = (sp.get("cart") || "").trim();
    if (t) localStorage.setItem("cart_token_b", t);
    t = localStorage.getItem("cart_token_b") || "";
    if (!t) {
      t = "b" + Math.random().toString(36).slice(2,10) + Date.now().toString(36).slice(2,6);
      localStorage.setItem("cart_token_b", t);
    }
    return t;
  }

  function money(n){
    try { return new Intl.NumberFormat("zh-TW").format(n||0); } catch { return String(n||0); }
  }

  // 允許你填 youtube_embed 的多種格式；最後都轉成 /embed/VIDEOID
  function toYouTubeEmbed(url){
    if(!url) return "";
    const s = String(url).trim();
    // 已經是 embed
    if (s.includes("youtube.com/embed/")) return s;
    // Shorts
    let m = s.match(/youtube\.com\/shorts\/([a-zA-Z0-9_-]{6,})/);
    if (m && m[1]) return "https://www.youtube.com/embed/" + m[1];
    // youtu.be
    m = s.match(/youtu\.be\/([a-zA-Z0-9_-]{6,})/);
    if (m && m[1]) return "https://www.youtube.com/embed/" + m[1];
    // watch?v=
    m = s.match(/[?&]v=([a-zA-Z0-9_-]{6,})/);
    if (m && m[1]) return "https://www.youtube.com/embed/" + m[1];
    return "";
  }

  const cartToken = getCartToken();
  $("tokenText").textContent = cartToken;
  $("apiText").textContent = API;

  $("btnCheckout").onclick = ()=> location.href = `./checkout.html?cart=${encodeURIComponent(cartToken)}`;
  $("btnReload").onclick = ()=> loadProducts();

  const state = { items: [], picked: null };

  async function loadProducts(){
    const inStock = $("filterStock").value === "1";
    const limit = 500; // 正式上線先抓 500，夠用再調
    const url = `${API}/public/products?limit=${limit}&in_stock=${inStock?1:0}`;

    $("grid").innerHTML = "";
    toast("載入商品中…");

    const res = await fetch(url, { method:"GET" });
    const data = await res.json().catch(()=> ({}));
    if(!res.ok || !data.ok){
      toast("載入失敗：" + (data.message || data.error || res.status));
      return;
    }
    state.items = data.items || [];
    render();
    toast(`已載入 ${state.items.length} 件商品`);
  }

  function matchQ(p, q){
    if(!q) return true;
    const s = q.toLowerCase();
    return [p.sku, p.name, p.brand].some(x => String(x||"").toLowerCase().includes(s));
  }

  function render(){
    const q = $("q").value.trim();
    const list = state.items.filter(p => matchQ(p, q));

    $("grid").innerHTML = list.map(p => {
      const img = p.image || "";
      const hasImg = !!img;
      const stock = Number(p.stock||0);
      return `
      <div class="card">
        <div class="imgbox">
          <div class="badge">${p.brand ? `品牌：${escapeHtml(p.brand)}` : `SKU：${escapeHtml(p.sku||"")}`}</div>
          ${hasImg ? `<img src="${escapeAttr(img)}" alt="img" loading="lazy" />` : `<div style="color:rgba(214,178,94,.75);font-weight:800">無圖片</div>`}
        </div>
        <div class="body">
          <div class="title">${escapeHtml(p.name || "")}</div>
          <div class="meta">
            <span>SKU：${escapeHtml(p.sku||"")}</span>
            <span>庫存：${stock}</span>
          </div>
          <div class="priceRow">
            <div class="price">$ ${money(p.price||0)}</div>
            <div class="miniBtns">
              <button class="miniBtn" onclick="openModal('${escapeAttr(p.sku||"")}')">查看</button>
              <button class="miniBtn primary" onclick="addToCart('${escapeAttr(p.sku||"")}')">加入購物車</button>
            </div>
          </div>
        </div>
      </div>`;
    }).join("");
  }

  function escapeHtml(s){
    return String(s||"")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#39;");
  }
  function escapeAttr(s){ return escapeHtml(s); }

  window.openModal = (sku)=>{
    const p = state.items.find(x => String(x.sku||"") === String(sku||""));
    if(!p) return;

    state.picked = p;
    $("mTitle").textContent = p.name || "";
    $("mMeta").innerHTML = `
      <span>SKU：${escapeHtml(p.sku||"")}</span>
      <span>品牌：${escapeHtml(p.brand||"")}</span>
      <span>庫存：${Number(p.stock||0)}</span>
      <span>價格：$ ${money(p.price||0)}</span>
    `;
    $("mDesc").textContent = p.desc || "";

    const img = p.image || "";
    $("mImg").src = img || "";
    $("mImg").style.display = img ? "block" : "none";
    if(!img){
      $("mImg").alt = "no image";
      $("mImg").style.display = "block";
      $("mImg").src = "data:image/svg+xml;charset=utf-8," + encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="1200" height="800"><rect width="100%" height="100%" fill="#111"/><text x="50%" y="50%" fill="#d6b25e" font-size="48" font-family="Arial" text-anchor="middle">NO IMAGE</text></svg>`);
    }

    const embed = toYouTubeEmbed(p.youtube_embed || "");
    if(embed){
      $("yt").src = embed;
      $("ytWrap").style.display = "block";
    }else{
      $("yt").src = "";
      $("ytWrap").style.display = "none";
    }

    $("mPrice").textContent = "$ " + money(p.price||0);
    $("mask").style.display = "flex";
  };

  $("mClose").onclick = ()=> closeModal();
  $("mask").addEventListener("click", (e)=>{ if(e.target === $("mask")) closeModal(); });
  function closeModal(){
    $("mask").style.display = "none";
    $("yt").src = "";
  }

  window.addToCart = async (sku)=>{
    const p = state.items.find(x => String(x.sku||"") === String(sku||""));
    if(!p) return;

    const res = await fetch(`${API}/cart/add`, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ cart_token: cartToken, sku: p.sku, qty: 1 })
    });
    const data = await res.json().catch(()=> ({}));
    if(!res.ok || !data.ok){
      toast("加入失敗：" + (data.message || data.error || res.status));
      return;
    }
    toast(`已加入購物車：${p.sku}`);
  };

  $("mAdd").onclick = ()=> {
    if(!state.picked) return;
    window.addToCart(state.picked.sku);
  };
  $("mCheckout").onclick = ()=> location.href = `./checkout.html?cart=${encodeURIComponent(cartToken)}`;

  $("q").addEventListener("input", ()=> render());

  loadProducts();
</script>
</body>
</html>
