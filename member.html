<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>MURAIN 寄賣精品｜會員中心</title>
  <meta name="robots" content="noindex,nofollow" />
  <style>
    /* --- 核心變數：改為大理石白金主題 (Marble & Gold) --- */
    :root{
      /* 背景：仿大理石的灰白基底 */
      --bg: #f7f7f7; 
      --surface: #ffffff;
      --surface-glass: rgba(255, 255, 255, 0.90);
      --card-bg: #ffffff;
      
      /* 金色系：參考圖片中的漸層金 */
      --gold: #b48b39; /* 深金，用於文字 */
      --gold-light: #F2D57C;
      --gold-gradient: linear-gradient(135deg, #cfaa5b 0%, #f4d889 50%, #cfaa5b 100%);
      
      /* 文字系：深色為主 */
      --text: #1a1a1a;
      --text-sub: #666666;
      
      /* 線條 */
      --line: #e0e0e0;
      --border-gold: #d4af37; /* 實體邊框金 */

      --font-main: "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", sans-serif;
      --font-serif: "Times New Roman", serif; /* 對應圖片的襯線體 */
      
      --status-bg: #f9f4e0;
      --status-text: #b48b39;
      
      --shadow: 0 4px 12px rgba(0,0,0,0.06);
    }

    *{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
    
    body{
      margin: 0; font-family: var(--font-main);
      background-color: var(--bg);
      /* 模擬大理石紋理的微妙背景 */
      background-image: 
        radial-gradient(at 10% 10%, rgba(200,200,200,0.1) 0%, transparent 50%),
        radial-gradient(at 90% 90%, rgba(200,200,200,0.1) 0%, transparent 50%);
      color: var(--text); padding-bottom: 60px;
    }
    
    .wrap{ max-width: 800px; margin: 0 auto; padding: 0; }

    /* --- 頂部導航 (白底金字) --- */
    .topbar {
      display: flex; align-items: center; justify-content: space-between;
      padding: 16px 20px; background: var(--surface-glass);
      backdrop-filter: blur(12px); 
      border-bottom: 1px solid var(--gold-light); /* 改為金色底線 */
      position: sticky; top: 0; z-index: 50;
      box-shadow: 0 2px 10px rgba(0,0,0,0.03);
    }
    .brand { 
      font-family: var(--font-serif); font-size: 22px; 
      color: #000; letter-spacing: 1px; font-weight: bold;
    }
    .btn-ghost {
      background: transparent; border: 1px solid var(--line); color: var(--text-sub);
      padding: 6px 12px; border-radius: 99px; font-size: 12px; cursor: pointer; text-decoration: none;
    }
    /* 隱藏 topbar 的「回官網」按鈕 */
    .topbar .btn-ghost{ display:none !important; }

    /* --- 主視覺 Banner (仿圖片中的金色方框風格) --- */
    .hero-banner {
      height: 140px; position: relative; overflow: hidden;
      display: flex; align-items: center; justify-content: center; flex-direction: column;
      background: #fff;
      margin: 20px 16px;
      /* 雙層邊框效果 */
      border: 1px solid var(--border-gold);
      box-shadow: 
        inset 0 0 0 3px #fff, 
        inset 0 0 0 4px var(--border-gold),
        0 4px 15px rgba(0,0,0,0.05);
      border-radius: 4px;
    }
    /* 移除原本的旋轉動畫，改為靜態優雅風格 */
    .hero-banner::before { display: none; }
    
    .hero-title { 
      font-family: var(--font-serif); font-size: 28px; 
      color: #000; letter-spacing: 2px; font-weight: bold;
      margin-bottom: 8px;
    }
    .hero-sub { 
      font-size: 12px; color: var(--gold); letter-spacing: 2px; 
      text-transform: uppercase; font-weight: 600;
    }

    /* --- 登入狀態列 (改為白色卡片) --- */
    .profile-bar {
      margin: 0 16px 24px; padding: 20px;
      background: #fff; 
      border-radius: 8px;
      display: flex; justify-content: space-between; align-items: center;
      border: 1px solid #eee;
      box-shadow: var(--shadow);
    }
    .profile-info { font-size: 14px; color: var(--text); display: flex; flex-direction: column; gap: 4px; }
    .profile-name { font-weight: bold; color: #000; font-size: 16px; font-family: var(--font-serif); }
    .profile-status { font-size: 12px; color: var(--text-sub); }
    
    /* 按鈕改為金色漸層，呼應圖片中的按鈕 */
    .btn-load {
      background: var(--gold-gradient); 
      color: #000; border: none;
      padding: 8px 20px; border-radius: 2px; /* 方形圓角 */
      font-weight: bold; font-size: 13px; cursor: pointer;
      box-shadow: 0 2px 5px rgba(180, 139, 57, 0.3);
      transition: opacity 0.2s;
    }
    .btn-load:active { opacity: 0.8; }

    /* 大頭照 */
    .profile-left{ display:flex; align-items:center; gap:16px; }
    .profile-avatar{
      width: 50px; height: 50px;
      border-radius: 50%;
      border: 2px solid var(--gold-light);
      object-fit: cover;
      background: #f0f0f0; /* 避免透明圖在白底看不見 */
      flex: 0 0 auto;
    }

    /* --- 訂單列表 (卡片式 - 白底金邊) --- */
    .container { padding: 0 16px; }
    /* 標題樣式：左右金色橫線，中間文字 */
    .section-title { 
      font-size: 16px; color: #000; margin-bottom: 20px; 
      letter-spacing: 2px; text-align: center; font-family: var(--font-serif);
      font-weight: bold;
      position: relative; display: flex; align-items: center; justify-content: center;
      border-left: none; padding-left: 0;
    }
    .section-title::before, .section-title::after {
      content: ''; display: block; width: 40px; height: 1px; background: var(--gold);
      margin: 0 12px;
    }

    .order-card {
      background: var(--card-bg); 
      border: 1px solid var(--line);
      border-radius: 8px; padding: 20px; margin-bottom: 16px;
      cursor: pointer; transition: all 0.2s; position: relative;
      box-shadow: 0 2px 8px rgba(0,0,0,0.03);
    }
    /* Hover 時顯示金色邊框 */
    .order-card:active, .order-card:hover { 
      border-color: var(--border-gold); 
      box-shadow: 0 4px 12px rgba(212, 175, 55, 0.2);
    }
    
    .card-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
    .order-id { font-family: monospace; font-size: 14px; color: #333; letter-spacing: 0.5px; font-weight: 600; }
    .order-status {
      font-size: 11px; padding: 4px 10px; border-radius: 99px;
      background: var(--status-bg); color: var(--status-text); 
      border: 1px solid rgba(212, 175, 55, 0.3);
      font-weight: bold;
    }
    
    .card-mid { display: flex; justify-content: space-between; align-items: center; border-top: 1px dashed #eee; padding-top: 12px; }
    .order-date { font-size: 12px; color: #999; }
    .order-total { font-family: var(--font-serif); font-size: 18px; color: #000; font-weight: bold; }
    
    .card-arrow { position: absolute; right: 20px; top: 50%; transform: translateY(-50%); color: #ccc; font-size: 20px; }

    /* --- 彈窗 (訂單詳情 - 白底) --- */
    .modal-mask {
      position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(2px);
      z-index: 100; display: none; align-items: flex-end; justify-content: center;
    }
    .modal-content {
      width: 100%; max-width: 600px; background: #fff;
      border-radius: 24px 24px 0 0; 
      max-height: 85vh; overflow-y: auto; display: flex; flex-direction: column;
      position: relative; animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      box-shadow: 0 -5px 30px rgba(0,0,0,0.1);
    }
    @keyframes slideUp { from {transform: translateY(100%);} to {transform: translateY(0);} }
    
    .modal-header { 
      padding: 16px 20px; border-bottom: 1px solid #eee; 
      display: flex; justify-content: space-between; align-items: center; 
      position: sticky; top:0; background:#fff; z-index:10; 
    }
    .modal-title { font-size: 16px; color: #000; font-weight: bold; font-family: var(--font-serif); }
    .close-btn { background: transparent; border: none; color: #999; font-size: 24px; cursor: pointer; padding: 0 8px; }

    .modal-body { padding: 24px; }
    
    .detail-group { margin-bottom: 24px; }
    .detail-label { 
      font-size: 13px; color: var(--gold); margin-bottom: 10px; 
      border-bottom: 1px solid var(--gold-light); padding-bottom: 6px; 
      display: block; letter-spacing: 1px; font-weight: bold; 
    }
    
    /* 商品列樣式 */
    .item-row { display: flex; justify-content: space-between; margin-bottom: 16px; font-size: 14px; align-items: flex-start; border-bottom: 1px solid #f5f5f5; padding-bottom: 12px; }
    .item-row:last-child { border-bottom: none; }
    .item-name { color: #333; flex: 1; padding-right: 12px; line-height: 1.5; }
    .item-meta { text-align: right; color: #000; font-family: var(--font-serif); min-width: 80px; font-weight: bold; }
    .item-sub { display: block; font-size: 12px; color: #999; margin-top: 4px; font-weight: normal; }

    /* 資訊網格 */
    .info-grid { display: grid; grid-template-columns: 1fr; gap: 12px; font-size: 14px; color: #555; }
    .info-row { display: flex; justify-content: space-between; border-bottom: 1px dashed #eee; padding-bottom: 8px; }
    .info-val { color: #000; font-family: monospace; text-align: right; font-weight: 500; }

    .empty-msg { 
      text-align: center; color: var(--text-sub); padding: 40px; 
      background: #fff; border-radius: 8px; border: 1px dashed var(--line); 
      box-shadow: var(--shadow);
    }

    .toast {
      position: fixed; left: 50%; bottom: 30px; transform: translateX(-50%);
      background: rgba(0,0,0,0.8); color: #fff; padding: 10px 24px;
      border-radius: 99px; font-size: 14px; font-weight: 500;
      box-shadow: 0 5px 20px rgba(0,0,0,0.2); display: none; z-index: 999;
    }
    
    /* 特殊調整：地址區塊 */
    #dAddr {
      margin-top:12px; line-height:1.6; 
      color:#555 !important; background:#f9f9f9 !important; 
      padding:12px !important; border-radius:8px; border:1px solid #eee;
    }
  </style>
</head>
<body>

  <div class="wrap">
    <div class="topbar">
      <div class="brand">MURAIN</div>
      <a href="./index.html" class="btn-ghost">← 回官網</a>
    </div>

    <div class="hero-banner">
      <div class="hero-title">會員中心</div>
      <div class="hero-sub">Member Center</div>
    </div>

    <div class="profile-bar">
      <div class="profile-left">
        <img
          id="lineAvatar"
          class="profile-avatar"
          referrerpolicy="no-referrer"
          alt=""
          src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='88' height='88'><rect width='100%25' height='100%25' fill='%23f0f0f0'/><circle cx='44' cy='34' r='16' fill='%23cccccc'/><rect x='18' y='56' width='52' height='22' rx='11' fill='%23cccccc'/></svg>"
        />
        <div class="profile-info">
          <span class="profile-name" id="lineName">訪客</span>
          <span class="profile-status" id="lineStatus">尚未登入</span>
        </div>
      </div>

      <button class="btn-load" id="btnLoad">重新整理</button>
    </div>

    <div class="container">
      <div class="section-title">歷史訂單</div>
      <div id="msg" style="font-size:12px;color:var(--text-sub);margin-bottom:10px;text-align:center;"></div>
      
      <div id="orderList">
        <div class="empty-msg">
          請點擊「登入 / 重新整理」<br>
          以查看您的歷史訂單
        </div>
      </div>
    </div>
  </div>

  <div class="modal-mask" id="detailModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">訂單詳情</div>
        <button class="close-btn" onclick="closeModal()">✕</button>
      </div>
      <div class="modal-body">
        
        <div class="detail-group">
          <label class="detail-label">基本資料</label>
          <div class="info-grid">
            <div class="info-row"><span>訂單編號</span><span class="info-val" id="dId"></span></div>
            <div class="info-row"><span>建立日期</span><span class="info-val" id="dDate"></span></div>
            <div class="info-row"><span>訂單狀態</span><span class="info-val" id="dStatus" style="color:var(--gold)"></span></div>
            <div class="info-row"><span>訂單金額</span><span class="info-val" id="dTotal" style="color:#000;font-size:16px;font-weight:bold"></span></div>
          </div>
        </div>

        <div class="detail-group">
          <label class="detail-label">購買商品</label>
          <div id="dItems"></div>
        </div>

        <div class="detail-group">
          <label class="detail-label">收件與寄送</label>
          <div class="info-grid">
             <div class="info-row"><span>寄送方式</span><span class="info-val" id="dShipMethod"></span></div>
             <div class="info-row"><span>物流單號</span><span class="info-val" id="dTrack"></span></div>
             <div id="dAddr"></div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <div style="display:none" id="apiText"></div>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
    // ====== 設定區 ======
    const API = new URL(location.href).searchParams.get("api") || "https://api2.murain.tw";
    
    // ★ 請在此填入您的 LIFF ID 以啟用 LINE 登入功能
    const LIFF_ID = "2006589075-qdYPyF0S"; 
    // ===================

    document.getElementById("apiText").textContent = API;
    const toastEl = document.getElementById("toast");
    const toast = (t)=>{ toastEl.textContent=t; toastEl.style.display="block"; clearTimeout(toastEl._t); toastEl._t=setTimeout(()=>toastEl.style.display="none",2000); }

    let idToken = "";
    let orders = [];

    // 初始化 LINE LIFF
    async function init(){
      if(!LIFF_ID){
        document.getElementById("msg").textContent = "系統提示：請於程式碼中設定 LIFF ID 才能啟用 LINE 登入。";
        return;
      }
      try{
        await liff.init({ liffId: LIFF_ID });

        if(!liff.isLoggedIn()){
          document.getElementById("lineStatus").textContent = "正在導向 LINE 登入...";
          liff.login({ redirectUri: location.href });
          return;
        }

        const p = await liff.getProfile();
        idToken = liff.getIDToken();

        document.getElementById("lineName").textContent = p.displayName || "會員";
        document.getElementById("lineStatus").textContent = "已透過 LINE 登入";

        const av = document.getElementById("lineAvatar");
        let pic = p.pictureUrl || (liff.getDecodedIDToken && liff.getDecodedIDToken()?.picture) || "";
        if(av && pic){
          try{
            const u = new URL(pic);
            u.searchParams.set("t", String(Date.now())); 
            av.src = u.toString();
          }catch(_e){
            av.src = pic;
          }
        }

        loadMyOrders();

      }catch(e){
        document.getElementById("msg").textContent = "LINE 初始化失敗: " + e.message;
      }
    }

    async function post(path, body){
      const res = await fetch(API + path, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(body||{})
      });
      const j = await res.json().catch(()=>null);
      if(!res.ok) throw new Error(j?.message || j?.error || "請求失敗");
      return j;
    }

    function money(n){ try{return new Intl.NumberFormat("zh-TW").format(Number(n||0));}catch{return String(n||0);} }
    function esc(s){ return String(s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }

    function render(){
      const container = document.getElementById("orderList");
      if(!orders.length){
        container.innerHTML = `<div class="empty-msg">目前沒有訂單記錄</div>`;
        return;
      }

      container.innerHTML = orders.map(o => `
        <div class="order-card" onclick="openOrder('${esc(o.order_id)}')">
          <div class="card-top">
            <span class="order-id">#${esc(o.order_id)}</span>
            <span class="order-status">${esc(o.status||"處理中")}</span>
          </div>
          <div class="card-mid">
            <div class="order-date">${esc(o.created_at?.split(' ')[0] || "")}</div>
            <div class="order-total">$ ${money(o.total_amount)}</div>
          </div>
          <div class="card-arrow">›</div>
        </div>
      `).join("");
    }

    async function loadMyOrders(){
      if(LIFF_ID && !liff.isLoggedIn()){
        liff.login();
        return;
      }
      if(!idToken && LIFF_ID) idToken = liff.getIDToken();
      if(!idToken) return toast("請先登入");

      const msg = document.getElementById("msg");
      msg.textContent = "資料載入中...";
      
      try{
        const data = await post("/member/orders", { id_token: idToken });
        orders = data.orders || [];
        render();
        msg.textContent = `共找到 ${orders.length} 筆訂單`;
      }catch(e){
        msg.textContent = "載入失敗：" + e.message;
        toast("錯誤：" + e.message);
      }
    }

    async function openOrder(order_id){
      document.getElementById("detailModal").style.display = "flex";
      
      const basic = orders.find(o => o.order_id === order_id) || {};
      document.getElementById("dId").textContent = order_id;
      document.getElementById("dDate").textContent = basic.created_at || "-";
      document.getElementById("dStatus").textContent = basic.status || "-";
      document.getElementById("dTotal").textContent = "$ " + money(basic.total_amount);
      document.getElementById("dItems").innerHTML = "<div style='color:#999;font-size:12px;padding:10px 0;'>載入詳細資料中...</div>";
      
      document.getElementById("dShipMethod").textContent = "-";
      document.getElementById("dTrack").textContent = "-";
      document.getElementById("dAddr").textContent = "";

      try{
        const data = await post("/member/order/get", { id_token: idToken, order_id });

        const o = data.order || {};
        const items = Array.isArray(data.items) ? data.items : [];

        let ship = {};
        try{
          if (o.shipping_info) {
            ship = (typeof o.shipping_info === "string")
              ? JSON.parse(o.shipping_info)
              : (o.shipping_info || {});
          }
        }catch(_e){
          ship = {};
        }

        document.getElementById("dItems").innerHTML =
          items.length
            ? items.map(it => `
              <div class="item-row">
                <div class="item-name">
                  ${esc(it.title || it.product_name || "商品")}
                  <span class="item-sub">SKU: ${esc(it.sku || "")}</span>
                </div>
                <div class="item-meta">
                  x${Number(it.qty||0)}<br>
                  $${money(it.price)}
                </div>
              </div>
            `).join("")
            : "<div style='color:#999;font-size:12px;padding:10px 0;'>此訂單沒有商品明細</div>";

        document.getElementById("dShipMethod").textContent = o.shipping_method || ship.ship_method || "-";
        document.getElementById("dTrack").textContent = o.tracking_no || "尚未產生";

        let addrStr = o.address || ship.address || "";
        if(ship.cvs){
          addrStr = `<span style="color:var(--gold)">[7-11 取貨]</span><br>門市：${ship.cvs.store_name} (${ship.cvs.store_id})<br>地址：${ship.cvs.store_addr||""}`;
        }
        document.getElementById("dAddr").innerHTML = addrStr || "無地址資訊";

      }catch(e){
        document.getElementById("dItems").innerHTML =
          `<div style="color:#ffb4b4;font-size:12px;padding:10px 0;">
            無法讀取詳細資料：${esc(e.message || String(e))}
          </div>`;
        try{ toast("明細讀取失敗：" + (e.message||e)); }catch(_){}
        console.log("order detail error:", e);
      }
    }

    function closeModal(){
      document.getElementById("detailModal").style.display = "none";
    }

    document.getElementById("btnLoad").onclick = loadMyOrders;

    init();
  </script>
</body>
</html>
