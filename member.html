<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>MURAIN 寄賣精品｜會員中心</title>
  <meta name="robots" content="noindex,nofollow" />
  <style>
    /* --- 核心變數：與官網一致的黑金主題 --- */
    :root{
      --bg: #050505;
      --surface: #141414;
      --surface-glass: rgba(20, 20, 20, 0.95);
      --card-bg: #18181b;
      --gold: #D4AF37;
      --text: #ffffff;
      --text-sub: #9e9e9e;
      --line: rgba(255, 255, 255, 0.12);
      --font-main: "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", sans-serif;
      --font-serif: "Times New Roman", serif; 
      --status-bg: rgba(212, 175, 55, 0.15);
      --status-text: #D4AF37;
    }

    *{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
    body{
      margin: 0; font-family: var(--font-main);
      background-color: var(--bg);
      background-image: radial-gradient(circle at 50% 0%, #1a1a20 0%, var(--bg) 60%);
      color: var(--text); padding-bottom: 60px;
    }
    
    .wrap{ max-width: 800px; margin: 0 auto; padding: 0; }

    /* --- 頂部導航 --- */
    .topbar {
      display: flex; align-items: center; justify-content: space-between;
      padding: 16px 20px; background: var(--surface-glass);
      backdrop-filter: blur(12px); border-bottom: 1px solid var(--line);
      position: sticky; top: 0; z-index: 50;
    }
    .brand { font-family: var(--font-serif); font-size: 20px; color: var(--gold); letter-spacing: 1px; }
    .btn-ghost {
      background: transparent; border: 1px solid var(--line); color: var(--text-sub);
      padding: 6px 12px; border-radius: 99px; font-size: 12px; cursor: pointer; text-decoration: none;
    }

    /* --- 主視覺 Banner --- */
    .hero-banner {
      height: 160px; position: relative; overflow: hidden;
      display: flex; align-items: center; justify-content: center; flex-direction: column;
      background: linear-gradient(135deg, #0f0f12 0%, #1a1a20 100%);
      border-bottom: 1px solid var(--line); margin-bottom: 24px;
    }
    .hero-banner::before {
      content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
      background: radial-gradient(circle, rgba(212, 175, 55, 0.10) 0%, transparent 60%);
      animation: rotateLight 20s linear infinite;
    }
    @keyframes rotateLight { from {transform: rotate(0deg);} to {transform: rotate(360deg);} }
    .hero-title { font-family: var(--font-serif); font-size: 26px; color: var(--gold); letter-spacing: 2px; position: relative; z-index: 2; margin-bottom: 6px; }
    .hero-sub { font-size: 13px; color: var(--text-sub); letter-spacing: 1px; position: relative; z-index: 2; }

    /* --- 登入狀態列 --- */
    .profile-bar {
      margin: 0 16px 20px; padding: 16px;
      background: rgba(255,255,255,0.03); border-radius: 12px;
      display: flex; justify-content: space-between; align-items: center;
      border: 1px solid var(--line);
    }
    .profile-info { font-size: 14px; color: #fff; display: flex; flex-direction: column; gap: 4px; }
    .profile-name { font-weight: bold; color: var(--gold); }
    .profile-status { font-size: 12px; color: var(--text-sub); }
    .btn-load {
      background: var(--gold); color: #000; border: none;
      padding: 8px 16px; border-radius: 99px; font-weight: bold; font-size: 13px; cursor: pointer;
    }

    /* --- 訂單列表 (卡片式) --- */
    .container { padding: 0 16px; }
    .section-title { font-size: 14px; color: var(--text-sub); margin-bottom: 12px; letter-spacing: 1px; border-left: 3px solid var(--gold); padding-left: 8px; }

    .order-card {
      background: var(--card-bg); border: 1px solid var(--line);
      border-radius: 16px; padding: 20px; margin-bottom: 16px;
      cursor: pointer; transition: border-color 0.2s; position: relative;
    }
    .order-card:active { border-color: var(--gold); transform: scale(0.99); }
    
    .card-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
    .order-id { font-family: monospace; font-size: 14px; color: #fff; letter-spacing: 0.5px; }
    .order-status {
      font-size: 11px; padding: 4px 8px; border-radius: 99px;
      background: var(--status-bg); color: var(--status-text); border: 1px solid rgba(212, 175, 55, 0.3);
    }
    
    .card-mid { display: flex; justify-content: space-between; align-items: center; }
    .order-date { font-size: 12px; color: var(--text-sub); }
    .order-total { font-family: var(--font-serif); font-size: 18px; color: var(--gold); }
    
    .card-arrow { position: absolute; right: 20px; top: 50%; transform: translateY(-50%); color: var(--line); font-size: 20px; }

    /* --- 彈窗 (訂單詳情) --- */
    .modal-mask {
      position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(5px);
      z-index: 100; display: none; align-items: flex-end; justify-content: center;
    }
    .modal-content {
      width: 100%; max-width: 600px; background: #18181b;
      border-radius: 24px 24px 0 0; border-top: 1px solid var(--line);
      max-height: 85vh; overflow-y: auto; display: flex; flex-direction: column;
      position: relative; animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    }
    @keyframes slideUp { from {transform: translateY(100%);} to {transform: translateY(0);} }
    
    .modal-header { padding: 16px 20px; border-bottom: 1px solid var(--line); display: flex; justify-content: space-between; align-items: center; position: sticky; top:0; background:#18181b; z-index:10; }
    .modal-title { font-size: 16px; color: #fff; font-weight: bold; }
    .close-btn { background: transparent; border: none; color: #fff; font-size: 24px; cursor: pointer; padding: 0 8px; }

    .modal-body { padding: 20px; }
    
    .detail-group { margin-bottom: 24px; }
    .detail-label { font-size: 12px; color: var(--text-sub); margin-bottom: 10px; border-bottom: 1px solid var(--line); padding-bottom: 6px; display: block; letter-spacing: 1px; }
    
    /* 商品列樣式 */
    .item-row { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 14px; align-items: flex-start; }
    .item-name { color: #eee; flex: 1; padding-right: 12px; line-height: 1.4; }
    .item-meta { text-align: right; color: var(--gold); font-family: var(--font-serif); min-width: 80px; }
    .item-sub { display: block; font-size: 12px; color: var(--text-sub); margin-top: 4px; }

    /* 資訊網格 */
    .info-grid { display: grid; grid-template-columns: 1fr; gap: 12px; font-size: 13px; color: #ccc; }
    .info-row { display: flex; justify-content: space-between; border-bottom: 1px dashed rgba(255,255,255,0.05); padding-bottom: 8px; }
    .info-val { color: #fff; font-family: monospace; text-align: right; }

    .empty-msg { text-align: center; color: var(--text-sub); padding: 40px; background: rgba(255,255,255,0.02); border-radius: 12px; border: 1px dashed var(--line); }

    .toast {
      position: fixed; left: 50%; bottom: 30px; transform: translateX(-50%);
      background: #fff; color: #000; padding: 10px 20px;
      border-radius: 99px; font-size: 14px; font-weight: 600;
      box-shadow: 0 5px 20px rgba(0,0,0,0.5); display: none; z-index: 999;
    }
  </style>
</head>
<body>

  <div class="wrap">
    <div class="topbar">
      <div class="brand">MURAIN</div>
      <a href="./index.html" class="btn-ghost">← 回官網</a>
    </div>

    <div class="hero-banner">
      <div class="hero-title">會員中心</div>
      <div class="hero-sub">Member Center</div>
    </div>

    <div class="profile-bar">
      <div class="profile-info">
        <span class="profile-name" id="lineName">訪客</span>
        <span class="profile-status" id="lineStatus">尚未登入</span>
      </div>
      <button class="btn-load" id="btnLoad">登入 / 重新整理</button>
    </div>

    <div class="container">
      <div class="section-title">歷史訂單</div>
      <div id="msg" style="font-size:12px;color:var(--text-sub);margin-bottom:10px;text-align:center;"></div>
      
      <div id="orderList">
        <div class="empty-msg">
          請點擊「登入 / 重新整理」<br>
          以查看您的歷史訂單
        </div>
      </div>
    </div>
  </div>

  <div class="modal-mask" id="detailModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">訂單詳情</div>
        <button class="close-btn" onclick="closeModal()">✕</button>
      </div>
      <div class="modal-body">
        
        <div class="detail-group">
          <label class="detail-label">基本資料</label>
          <div class="info-grid">
            <div class="info-row"><span>訂單編號</span><span class="info-val" id="dId"></span></div>
            <div class="info-row"><span>建立日期</span><span class="info-val" id="dDate"></span></div>
            <div class="info-row"><span>訂單狀態</span><span class="info-val" id="dStatus" style="color:var(--gold)"></span></div>
            <div class="info-row"><span>訂單金額</span><span class="info-val" id="dTotal" style="color:var(--gold);font-size:16px;font-weight:bold"></span></div>
          </div>
        </div>

        <div class="detail-group">
          <label class="detail-label">購買商品</label>
          <div id="dItems"></div>
        </div>

        <div class="detail-group">
          <label class="detail-label">收件與寄送</label>
          <div class="info-grid">
             <div class="info-row"><span>寄送方式</span><span class="info-val" id="dShipMethod"></span></div>
             <div class="info-row"><span>物流單號</span><span class="info-val" id="dTrack"></span></div>
             <div style="margin-top:12px;line-height:1.6;color:#ccc;background:rgba(255,255,255,0.05);padding:10px;border-radius:8px;" id="dAddr"></div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <div style="display:none" id="apiText"></div>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
    // ====== 設定區 ======
    const API = new URL(location.href).searchParams.get("api") || "https://api2.murain.tw";
    
    // ★ 請在此填入您的 LIFF ID 以啟用 LINE 登入功能
    const LIFF_ID = "2006589075-qdYPyF0S"; 
    // ===================

    document.getElementById("apiText").textContent = API;
    const toastEl = document.getElementById("toast");
    const toast = (t)=>{ toastEl.textContent=t; toastEl.style.display="block"; clearTimeout(toastEl._t); toastEl._t=setTimeout(()=>toastEl.style.display="none",2000); }

    let idToken = "";
    let orders = [];

    // 初始化 LINE LIFF
    async function init(){
      if(!LIFF_ID){
        document.getElementById("msg").textContent = "系統提示：請於程式碼中設定 LIFF ID 才能啟用 LINE 登入。";
        return;
      }
      try{
        await liff.init({ liffId: LIFF_ID });
        if(!liff.isLoggedIn()){
  document.getElementById("lineStatus").textContent = "正在導向 LINE 登入...";
  liff.login({ redirectUri: location.href }); // ✅ 一打開就要求登入
  return;
} else {
  const p = await liff.getProfile();
  idToken = liff.getIDToken();
  document.getElementById("lineName").textContent = p.displayName;
  document.getElementById("lineStatus").textContent = "已透過 LINE 登入";
  loadMyOrders();
}
      }catch(e){
        document.getElementById("msg").textContent = "LINE 初始化失敗: " + e.message;
      }
    }

    // API 請求工具
    async function post(path, body){
      const res = await fetch(API + path, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(body||{})
      });
      const j = await res.json().catch(()=>null);
      if(!res.ok) throw new Error(j?.message || j?.error || "請求失敗");
      return j;
    }

    function money(n){ try{return new Intl.NumberFormat("zh-TW").format(Number(n||0));}catch{return String(n||0);} }
    function esc(s){ return String(s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }

    // 渲染訂單列表 (卡片樣式)
    function render(){
      const container = document.getElementById("orderList");
      if(!orders.length){
        container.innerHTML = `<div class="empty-msg">目前沒有訂單記錄</div>`;
        return;
      }

      container.innerHTML = orders.map(o => `
        <div class="order-card" onclick="openOrder('${esc(o.order_id)}')">
          <div class="card-top">
            <span class="order-id">#${esc(o.order_id)}</span>
            <span class="order-status">${esc(o.status||"處理中")}</span>
          </div>
          <div class="card-mid">
            <div class="order-date">${esc(o.created_at?.split(' ')[0] || "")}</div>
            <div class="order-total">$ ${money(o.total_amount)}</div>
          </div>
          <div class="card-arrow">›</div>
        </div>
      `).join("");
    }

    // 載入訂單邏輯
    async function loadMyOrders(){
      if(LIFF_ID && !liff.isLoggedIn()){
        liff.login();
        return;
      }
      if(!idToken && LIFF_ID) idToken = liff.getIDToken();
      if(!idToken) return toast("請先登入");

      const msg = document.getElementById("msg");
      msg.textContent = "資料載入中...";
      
      try{
        const data = await post("/member/orders", { id_token: idToken });
        orders = data.orders || [];
        render();
        msg.textContent = `共找到 ${orders.length} 筆訂單`;
      }catch(e){
        msg.textContent = "載入失敗：" + e.message;
        toast("錯誤：" + e.message);
      }
    }

    // 打開訂單詳情 (彈窗)
    async function openOrder(order_id){
      document.getElementById("detailModal").style.display = "flex";
      
      // 先填入列表已有的基本資料，讓使用者不用等
      const basic = orders.find(o => o.order_id === order_id) || {};
      document.getElementById("dId").textContent = order_id;
      document.getElementById("dDate").textContent = basic.created_at || "-";
      document.getElementById("dStatus").textContent = basic.status || "-";
      document.getElementById("dTotal").textContent = "$ " + money(basic.total_amount);
      document.getElementById("dItems").innerHTML = "<div style='color:#999;font-size:12px;padding:10px 0;'>載入詳細資料中...</div>";
      
      // 清空詳細欄位
      document.getElementById("dShipMethod").textContent = "-";
      document.getElementById("dTrack").textContent = "-";
      document.getElementById("dAddr").textContent = "";

      try{
        const data = await post("/member/order/get", { id_token: idToken, order_id });
        const o = data.order || {};
        const items = data.items || [];
        const ship = o.shipping_info ? JSON.parse(o.shipping_info) : {};

        // 渲染商品清單
        document.getElementById("dItems").innerHTML = items.map(it => `
          <div class="item-row">
            <div class="item-name">
              ${esc(it.title || it.product_name || "商品")}
              <span class="item-sub">SKU: ${esc(it.sku)}</span>
            </div>
            <div class="item-meta">
              x${it.qty}<br>
              $${money(it.price)}
            </div>
          </div>
        `).join("");

        // 渲染寄送資訊
        document.getElementById("dShipMethod").textContent = o.shipping_method || ship.ship_method || "-";
        document.getElementById("dTrack").textContent = o.tracking_no || "尚未產生";
        
        // 組合地址顯示 (包含 7-11 門市資訊)
        let addrStr = o.address || ship.address || "";
        if(ship.cvs){
          addrStr = `<span style="color:var(--gold)">[7-11 取貨]</span><br>門市：${ship.cvs.store_name} (${ship.cvs.store_id})<br>地址：${ship.cvs.store_addr||""}`;
        }
        document.getElementById("dAddr").innerHTML = addrStr || "無地址資訊";

      }catch(e){
        document.getElementById("dItems").innerHTML = "無法讀取詳細資料";
      }
    }

    function closeModal(){
      document.getElementById("detailModal").style.display = "none";
    }

    document.getElementById("btnLoad").onclick = loadMyOrders;

    init();
  </script>
</body>
</html>
