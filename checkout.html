<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>結帳購物車 · MURAIN 寄賣</title>
  <style>
    :root{
      --bg:#0b0a0a;
      --card:#141212;
      --text:#f3f1f1;
      --muted:#b9b3b3;
      --gold:#c8a25a;
      --border:rgba(200,162,90,.25);
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC"; background:radial-gradient(1200px 700px at 50% 0%, #191414 0%, var(--bg) 55%, #050404 100%); color:var(--text);}
    .wrap{max-width:980px; margin:0 auto; padding:18px;}
    a{color:inherit}
    .panel{border:1px solid var(--border); background:rgba(255,255,255,.03); border-radius:18px; padding:16px;}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
    .btn{
      padding:10px 12px; border-radius:12px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      color:var(--text);
      cursor:pointer;
    }
    .btn.primary{
      background:linear-gradient(135deg, rgba(200,162,90,.25), rgba(200,162,90,.10));
      border-color:rgba(200,162,90,.55);
    }
    input,textarea{
      width:100%; padding:10px 12px; border-radius:12px;
      border:1px solid var(--border);
      background:rgba(0,0,0,.25);
      color:var(--text);
      outline:none;
    }
    textarea{min-height:90px}
    .muted{color:var(--muted); font-size:13px}
    .line{display:flex; justify-content:space-between; gap:12px; padding:12px 0; border-bottom:1px solid rgba(200,162,90,.12)}
    .tot{font-size:18px; font-weight:800; color:var(--gold)}
    .grid{display:grid; grid-template-columns:1fr 1fr; gap:12px;}
    @media (max-width:640px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="panel">
      <div class="row" style="justify-content:space-between">
        <div>
          <b style="font-size:18px;">結帳購物車</b>
          <div class="muted">API：<span id="apiText"></span></div>
        </div>
        <div class="row">
          <a class="btn" href="./index.html">回寄賣官網</a>
          <button class="btn" onclick="reload()">刷新</button>
          <button class="btn" onclick="newCart()">換一個 cart_token</button>
        </div>
      </div>

      <div style="height:10px"></div>
      <div class="muted">cart_token：<b id="cartTokenText"></b></div>

      <div id="cart" style="margin-top:10px;"></div>

      <div style="margin-top:10px" class="row" style="justify-content:space-between">
        <b>合計</b>
        <div class="tot">$ <span id="total">0</span></div>
      </div>
    </div>

    <div style="height:14px"></div>

    <div class="panel">
      <b style="font-size:16px;">填寫資料並送出訂單（先用匯款/人工對帳，最快上線）</b>
      <div class="muted">送出後會寫入 Airtable 的 Orders 表（status = pending_transfer）。</div>
      <div style="height:12px"></div>

      <div class="grid">
        <div><input id="name" placeholder="姓名（必填）"></div>
        <div><input id="phone" placeholder="手機（必填）"></div>
      </div>
      <div style="height:10px"></div>
      <textarea id="address" placeholder="地址（選填，寄送用）"></textarea>
      <div style="height:10px"></div>
      <textarea id="note" placeholder="備註（選填，例如匯款末五碼/取件偏好）"></textarea>
      <div style="height:10px"></div>

      <button class="btn primary" onclick="checkout()">送出訂單</button>
      <div id="checkoutMsg" class="muted" style="margin-top:10px"></div>

      <div style="margin-top:12px; padding:12px; border:1px dashed rgba(200,162,90,.35); border-radius:14px;">
        <b>匯款資訊（你自己改成你的內容）</b>
        <div class="muted">銀行：＿＿＿＿　帳號：＿＿＿＿　戶名：＿＿＿＿</div>
        <div class="muted">匯款後請在備註填末五碼，我們確認後會通知出貨。</div>
      </div>
    </div>
  </div>

<script>
  const API = "https://api2.murain.tw";
  document.getElementById("apiText").textContent = API;

  const KEY_CART = "b_cart_token";
  function getCartToken(){
    // 允許從網址帶 ?cart=
    const u = new URL(location.href);
    const qCart = (u.searchParams.get("cart") || "").trim();
    if(qCart){
      localStorage.setItem(KEY_CART, qCart);
      return qCart;
    }
    let t = localStorage.getItem(KEY_CART);
    if(!t){ t = "b" + Math.random().toString(36).slice(2,10); localStorage.setItem(KEY_CART, t); }
    return t;
  }
  function setCartToken(t){ localStorage.setItem(KEY_CART, t); }
  function showCartToken(){ document.getElementById("cartTokenText").textContent = getCartToken(); }

  function money(n){ return (Number(n||0)||0).toLocaleString("zh-Hant"); }

  async function loadCart(){
    showCartToken();
    const cart_token = getCartToken();
    const el = document.getElementById("cart");
    el.innerHTML = `<div class="muted">載入中…</div>`;

    const r = await fetch(`${API}/cart/items?cart_token=${encodeURIComponent(cart_token)}`);
    const d = await r.json();
    const items = (d.ok && Array.isArray(d.items)) ? d.items : [];

    if(!items.length){
      el.innerHTML = `<div class="muted" style="padding:10px 0">購物車是空的，請回首頁加入商品。</div>`;
      document.getElementById("total").textContent = "0";
      return;
    }

    let total = 0;
    el.innerHTML = items.map(it=>{
      const qty = Math.max(1, Number(it.qty||1)||1);
      const price = Number(it.price||0)||0;
      const line = qty * price;
      total += line;
      return `
        <div class="line">
          <div>
            <b>${escapeHtml(it.sku||"")}</b>
            <div class="muted">qty：${qty}　單價：$ ${money(price)}</div>
          </div>
          <div><b>$ ${money(line)}</b></div>
        </div>
      `;
    }).join("");

    document.getElementById("total").textContent = money(total);
  }

  async function checkout(){
    const cart_token = getCartToken();
    const customer_name = document.getElementById("name").value.trim();
    const phone = document.getElementById("phone").value.trim();
    const address = document.getElementById("address").value.trim();
    const note = document.getElementById("note").value.trim();

    const msg = document.getElementById("checkoutMsg");
    msg.textContent = "送出中…";

    const r = await fetch(`${API}/checkout`, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ cart_token, customer_name, phone, address, note })
    });
    const d = await r.json();
    if(!d.ok){
      msg.textContent = "結帳失敗：" + (d.message || d.error);
      return;
    }
    msg.innerHTML = `✅ 訂單建立成功：<b>${d.order_id}</b>　金額：$ ${money(d.total_amount)}<br>${escapeHtml(d.message || "")}`;
  }

  function newCart(){
    const t = "b" + Math.random().toString(36).slice(2,10);
    setCartToken(t);
    // 也把網址 cart 參數清掉
    const u = new URL(location.href);
    u.searchParams.delete("cart");
    history.replaceState(null, "", u.toString());
    loadCart();
  }

  function reload(){ loadCart(); }

  function escapeHtml(s){
    return String(s||"")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#39;");
  }

  // init
  loadCart();
</script>
</body>
</html>
