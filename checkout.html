<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>MURAIN｜購物車</title>
  <meta name="robots" content="noindex,nofollow" />
  <style>
    /* --- 核心變數：白金奢華風格 (與會員中心一致) --- */
    :root{
      --bg: #f9f9f9; /* 背景改亮 */
      --surface: #ffffff;
      --surface-glass: rgba(255, 255, 255, 0.95);
      --card-bg: #ffffff;
      --gold: #b38e46; /* 較深沈穩的金色 */
      --gold-light: #f4e4bc;
      --text: #333333; /* 文字改深色 */
      --text-sub: #777777;
      --line: rgba(179, 142, 70, 0.2); /* 淡淡的金色線條 */
      --danger: #d64d4d;
      --font-main: "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", sans-serif;
      --font-serif: "Times New Roman", serif;
      --shadow: 0 4px 12px rgba(179, 142, 70, 0.1);
    }

    *{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
    
    body{
      margin: 0; font-family: var(--font-main);
      background-color: var(--bg);
      /* 模擬大理石紋理的背景 */
      background-image: 
        radial-gradient(at 10% 10%, rgba(179,142,70,0.03) 0%, transparent 50%),
        radial-gradient(at 90% 90%, rgba(179,142,70,0.03) 0%, transparent 50%);
      color: var(--text); padding-bottom: 60px;
    }
    
    .wrap{ max-width: 800px; margin: 0 auto; padding: 0; }

    /* --- Topbar --- */
    .topbar {
      display: flex;
      align-items: center; justify-content: space-between;
      padding: 16px 20px; background: var(--surface-glass);
      backdrop-filter: blur(12px); border-bottom: 1px solid var(--line);
      position: sticky; top: 0;
      z-index: 50;
    }
    .brand { font-family: var(--font-serif); font-size: 20px; color: var(--gold); letter-spacing: 1px; font-weight: bold; }
    .btn-ghost {
      background: transparent; border: 1px solid var(--line); color: var(--text-sub);
      padding: 6px 12px; border-radius: 99px; font-size: 12px; cursor: pointer; text-decoration: none;
    }

    /* --- Hero Banner (金屬漸層風格) --- */
    .hero-banner {
      height: 160px;
      position: relative; overflow: hidden;
      display: flex; align-items: center; justify-content: center; flex-direction: column;
      /* 金屬漸層背景 */
      background: linear-gradient(135deg, #a67c33 0%, #e8d08b 25%, #fbf5b7 50%, #e8d08b 75%, #a67c33 100%);
      border-bottom: 1px solid #d4af37; 
      margin-bottom: 24px;
      box-shadow: 0 4px 10px rgba(166, 124, 51, 0.2);
    }
    .hero-banner::before {
      content: '';
      position: absolute; top: 0; left: -100%; width: 50%; height: 100%;
      background: linear-gradient(to right, transparent, rgba(255,255,255,0.4), transparent);
      transform: skewX(-25deg);
      animation: shine 6s infinite;
    }
    @keyframes shine { 
      0% { left: -100%; } 
      20% { left: 200%; } 
      100% { left: 200%; } 
    }

    .hero-title { 
      font-family: var(--font-serif);
      font-size: 28px; 
      color: #2c2108; /* 深色文字 */
      letter-spacing: 2px; position: relative; z-index: 2; font-weight: bold;
      text-shadow: 0 1px 0 rgba(255,255,255,0.4);
    }
    .hero-sub { 
      font-size: 13px; color: #584618; 
      letter-spacing: 3px; position: relative; z-index: 2; margin-top: 8px; font-weight: 600;
    }

    /* --- Layout Components --- */
    .container { padding: 0 16px; }
    
    .section-title {
      font-size: 16px; color: #333;
      margin: 30px 0 12px;
      font-weight: bold; letter-spacing: 0.5px; display: flex; align-items: center; gap: 8px;
    }
    .section-title::after { content:''; flex:1; height:2px; background:var(--gold); opacity: 0.3; }

    .card {
      background: var(--card-bg); 
      border: 1px solid rgba(0,0,0,0.05);
      border-left: 4px solid var(--gold); /* 左側金條裝飾 */
      border-radius: 12px;
      padding: 20px; margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }

    /* --- Inputs --- */
    .input-group { margin-bottom: 16px; }
    .label { font-size: 13px; color: var(--text); font-weight: bold; margin-bottom: 6px; display: block; }
    
    input, select, textarea {
      width: 100%; background: #fcfcfc;
      border: 1px solid #ddd; color: #333;
      border-radius: 8px; padding: 14px 16px; font-size: 14px; outline: none;
      font-family: inherit; transition: all 0.3s;
    }
    input:focus, select:focus, textarea:focus { 
      border-color: var(--gold); 
      background: #fff;
      box-shadow: 0 0 0 3px rgba(179, 142, 70, 0.1);
    }
    textarea { min-height: 100px; resize: vertical; }
    input::placeholder { color: #aaa; }
    
    .row-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

    /* --- Cart Items --- */
    .cart-item {
      display: flex;
      justify-content: space-between; align-items: flex-start;
      padding: 12px 0; border-bottom: 1px dashed #eee;
    }
    .cart-item:last-child { border-bottom: none; }
    .item-info { flex: 1; margin-right: 12px; }
    .item-name { font-size: 14px; line-height: 1.4; color: var(--text); margin-bottom: 4px; font-weight: 500; }
    .item-meta { font-size: 12px; color: var(--text-sub); font-family: monospace; }
    .item-price { font-family: var(--font-serif); color: var(--gold); font-size: 16px; white-space: nowrap; font-weight: bold; }

    .total-row {
      display: flex; justify-content: space-between; align-items: center;
      margin-top: 16px;
      padding-top: 16px; border-top: 2px solid #eee;
    }
    .total-label { font-size: 14px; color: #333; font-weight: bold; }
    .total-amount { font-family: var(--font-serif); font-size: 24px; color: #c5a059; font-weight: bold; }

    /* --- Action Buttons --- */
    .btn-submit {
      width: 100%;
      background: linear-gradient(to bottom, #d4af37, #b38e46); /* 金色漸層 */
      color: #fff;
      padding: 16px; border-radius: 12px; font-size: 16px; font-weight: bold;
      border: none; cursor: pointer; margin-top: 10px;
      box-shadow: 0 4px 15px rgba(179, 142, 70, 0.3);
      text-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    .btn-submit:active { transform: scale(0.98); }

    .note-text { font-size: 12px; color: var(--text-sub); line-height: 1.5; margin-top: 12px; text-align: center; }

    /* --- Toast & Utility --- */
    .toast {
      position: fixed;
      left: 50%; bottom: 30px; transform: translateX(-50%);
      background: rgba(0,0,0,0.8); color: #fff; padding: 10px 20px;
      border-radius: 99px; font-size: 14px; font-weight: 600;
      box-shadow: 0 5px 20px rgba(0,0,0,0.2); display: none; z-index: 999;
    }
    .hidden { display: none; }
    
    .k { color: var(--text-sub); font-size: 12px; }
    .mono { font-family: monospace; color: var(--text); font-size: 15px; }
    .btnGhost {
      background: #eee; border:none; padding:4px 10px; border-radius:4px; font-size:12px; cursor:pointer; color:#555;
    }

    .topbar a[href="./index.html"]{ display:none !important; }
.topbar{ justify-content:center !important; }
    /* ✅ 7-11 選店按鈕：改成主按鈕樣式（只影響 #btnPick711） */
#btnPick711{
  width:100%;
  padding: 14px 16px;
  border-radius: 12px;
  border: 1px solid var(--gold);
  background: linear-gradient(to bottom, #d4af37, #b38e46);
  color: #fff;
  font-weight: 800;
  letter-spacing: 1px;
  font-size: 14px;
  box-shadow: 0 4px 15px rgba(179, 142, 70, 0.25);
}
#btnPick711:active{ transform: scale(0.98); }

  </style>
</head>
<body>

  <div class="wrap">
    <div class="topbar">
      <div class="brand">MURAIN</div>
      <a href="./index.html" class="btn-ghost">← 回官網</a>
    </div>

    <div class="hero-banner">
      <div class="hero-title">結帳中心</div>
      <div class="hero-sub">安全支付結帳</div>
    </div>

    <div class="container">
      
      <div class="section-title">購物車內容</div>
      <div class="card">
        <div id="items">載入中...</div>
        <div class="total-row">
          <div class="total-label">總金額</div>
          <div class="total-amount">$ <span id="total">0</span></div>
        </div>
      </div>

      <div class="section-title">顧客資料</div>
      <div class="card">
        <div class="row-2">
          <div class="input-group">
            <label class="label">姓名</label>
            <input id="name" placeholder="請填寫真實姓名" />
          </div>
          <div class="input-group">
            <label class="label">電話</label>
            <input id="phone" placeholder="09xxxxxxxx" />
          </div>
        </div>
        <div class="input-group">
          <label class="label">電子信箱 (接收訂單通知)</label>
          <input id="email" placeholder="example@email.com" />
        </div>
      </div>

      <div class="section-title">付款與運送</div>
      <div class="card">
        
        <div class="input-group">
          <label class="label">付款方式</label>
          <select id="payMethod">
            <option value="" disabled selected>請選擇付款方式</option>
            <option value="cvs_cod">7-11 貨到付款</option>
            <option value="bank_transfer">銀行匯款</option>
            <option value="payuni_card">線上刷卡</option>
            <option value="payuni_3">線上刷卡 - 3期零利率</option>
            <option value="payuni_6">線上刷卡 - 6期零利率</option>
            <option value="payuni_9">線上刷卡 - 9期零利率</option>
            <option value="payuni_af">AF 先享後付</option>
            <option value="payuni_linepay">LINE Pay</option>
          </select>
        </div>

        <div id="bankBox" class="card" style="display:none; margin-top:10px; background:#fdfbf7; border:1px dashed var(--gold);">
          <div class="k">匯款帳號</div>
          <div class="row" style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:6px;">
            <div class="mono" id="bankText" style="font-weight:900;"></div>
            <button type="button" class="btnGhost" id="btnCopyBank">一鍵複製</button>
          </div>
          <div class="k" style="margin-top:6px;">⭐匯款後請在備註填寫：後五碼 / 金額 / 時間，方便對帳。</div>
        </div>

        <div class="input-group">
          <label class="label">運送方式</label>
          <select id="shipMethod">
            <option value="cvs_711">7-11 門市取貨</option>
            <option value="home">郵寄</option>
          </select>
        </div>

        <div id="cvsBox" class="hidden">
          <div class="input-group">
            <label class="label" style="color:var(--gold)">7-11 門市資訊</label>

            <button type="button" class="btn-ghost" id="btnPick711" style="margin:8px 0 10px;">
              選擇 7-11 門市
            </button>

            <div class="row-2" style="margin-bottom:10px">
              <input id="cvsStoreId" placeholder="門市代號 (會自動帶入)" readonly />
              <input id="cvsStoreName" placeholder="門市名稱 (會自動帶入)" readonly />
            </div>
            <input id="cvsAddr" placeholder="門市地址 (會自動帶入)" readonly />

            <div style="font-size:11px;color:var(--text-sub);margin-top:6px">
              ⭐ 0 元包裹須核對證件,請填寫真實姓名
            </div>
          </div>
        </div>

        <div id="homeBox" class="hidden">
          <div class="input-group">
            <label class="label" style="color:var(--gold)">收件地址</label>
            <textarea id="address" placeholder="請填寫完整收件地址 (縣市/區/路/號)"></textarea>
                <!-- ✅ 新增這行：textarea 下一行提示 -->
    <div class="hint" style="margin-top:6px; font-size:12px; color:rgba(242,210,122,.85); line-height:1.4;">
      ⭐郵寄不會電聯，須確保有人收件
    </div>
          </div>
        </div>

        <div class="input-group">
          <label class="label">備註</label>
          <textarea id="note" style="min-height:60px" placeholder="匯款帳號末五碼、送禮需精品提袋..."></textarea>
        </div>

      </div>

      <button class="btn-submit" id="btnSubmit">送出訂單</button>
      <div id="submitMsg" style="text-align:center;margin-top:10px;color:var(--gold)"></div>
      <div class="note-text" id="result">
        點擊送出即代表同意購買條款。<br>
        匯款訂單請於 24 小時內完成付款。
      </div>

    </div>
  </div>

  <div class="toast" id="toast"></div>

  <div style="display:none">
    <span id="apiText"></span>
    <span id="cartText"></span>
  </div>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
    /* ---- 核心設定 ---- */
    const API_DEFAULT = "https://api2.murain.tw";
    const LIFF_ID = "2006589075-qdYPyF0S"; // 若需要強制 LINE 登入請填入
    const API = new URL(location.href).searchParams.get("api") || API_DEFAULT;
    document.getElementById("apiText").textContent = API;
    const LS_TOKEN = "murain_b_cart_token";
    
    // UI Elements
    const toastEl = document.getElementById("toast");
    const itemsEl = document.getElementById("items");
    const totalEl = document.getElementById("total");
    
    /* --- 工具函式 --- */
    function genToken(){
      return "b" + Math.random().toString(36).slice(2, 6) + Date.now().toString(36).slice(-4);
    }
    function getToken(){
      const u = new URL(location.href);
      const tQ = u.searchParams.get("cart") || u.searchParams.get("cart_token");
      if (tQ) { localStorage.setItem(LS_TOKEN, tQ); return tQ; }
      let t = localStorage.getItem(LS_TOKEN);
      if (!t){ t = genToken(); localStorage.setItem(LS_TOKEN, t); }
      return t;
    }
    const cart_token = getToken();
    document.getElementById("cartText").textContent = cart_token;
    function money(n){ try{ return new Intl.NumberFormat("zh-TW").format(Number(n||0)); }catch{ return String(n||0); } }
    
    function toast(t){
      toastEl.textContent = t;
      toastEl.style.display = "block";
      clearTimeout(toastEl._t); toastEl._t = setTimeout(()=> toastEl.style.display="none", 2000);
    }

   /* --- API 函式 --- */
    async function apiGet(u){
      const res = await fetch(u, { method:"GET" });
      const j = await res.json().catch(()=>null);
      if (!res.ok) throw new Error(j?.message || j?.error || "fetch_failed");
      return j;
    }
    async function apiPost(u, data){
      const res = await fetch(u, {
        method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(data||{})
      });
      const j = await res.json().catch(()=>null);
      if (!res.ok) throw new Error(j?.message || j?.error || "post_failed");
      return j;
    }

   /* --- LINE Login (Optional) --- */
    let LINE = { ok:false, userId:"", idToken:"", name:"" };
    async function initLINE(){
      if(!LIFF_ID){
        toast("缺少 LIFF_ID，無法結帳");
        return; 
      }
      try{
        await liff.init({ liffId: LIFF_ID });
        if(!liff.isLoggedIn()){
          liff.login({ redirectUri: location.href });
          return;
        }

        const prof = await liff.getProfile();
        const idToken = liff.getIDToken() || "";

        LINE.ok = true;
        LINE.userId = prof.userId || "";
        LINE.name = prof.displayName || "";
        try{
          localStorage.setItem("line_user_id", LINE.userId);
          localStorage.setItem("line_display_name", LINE.name);
          localStorage.setItem("line_id_token", idToken);
        }catch(e){}
      }catch(e){
        console.error(e);
      }
    }
    const LINE_INIT_PROMISE = initLINE();

        // ✅ 會員中心：member.html（你已確認）
    const MEMBER_CENTER_URL = new URL("./member.html", location.href).toString();

    // ✅ 結單送出通知卡：同一張單只發一次（避免重複）
// ✅ 新增：同時自動發送文字「MURAIN 寄賣品 - 已下單」並跳回官方 LINE
async function sendOrderSubmittedCardOnce(orderId){
  try{
    if(!orderId) return;

    // 確保 LIFF init 完成（避免付款回跳時太快觸發）
    try{ await (typeof LINE_INIT_PROMISE !== "undefined" ? LINE_INIT_PROMISE : Promise.resolve()); }catch(e){}

    const sentKey = `sent_card_${orderId}`;
    if (localStorage.getItem(sentKey) === "1") {
      // 已送過也直接回 LINE（只在 LINE App 內有效）
      if (window.liff && liff.isInClient && liff.isInClient()){
        try{ liff.closeWindow(); }catch(e){}
      }
      return;
    }

    // 只能在 LINE App 內的 LIFF 才能發送訊息
    if (!window.liff || !liff.isInClient || !liff.isInClient()) return;

    await liff.sendMessages([
      // ✅ 你要新增的那句文字（會送到「開啟此 LIFF 的聊天室」，通常就是官方帳號）
      { type: "text", text: "MURAIN 寄賣品 - 已下單" },

      // ✅ 原本的 Flex 卡片（保留不動）
      {
        type: "flex",
        altText: "✅ 結單已送出",
        contents: {
          type: "bubble",
          body: {
            type: "box",
            layout: "vertical",
            spacing: "md",
            contents: [
              { type: "text", text: "✅ 結單已送出", weight: "bold", size: "lg" },
              { type: "text", text: `訂單編號：${orderId}`, size: "sm", wrap: true, color: "#666666" },
              { type: "text", text: "可到會員中心查看訂單狀態與出貨進度。", size: "sm", wrap: true, color: "#666666" }
            ]
          },
          footer: {
            type: "box",
            layout: "vertical",
            spacing: "sm",
            contents: [{
              type: "button",
              style: "primary",
              action: { type: "uri", label: "到會員中心查看訂單", uri: MEMBER_CENTER_URL }
            }]
          }
        }
      }
    ]);

    localStorage.setItem(sentKey, "1");

    // ✅ 送完訊息 → 跳回官方 LINE（回到聊天室）
    setTimeout(()=>{ try{ liff.closeWindow(); }catch(e){} }, 350);

  }catch(e){
    console.warn("send card/text failed:", e);
  }
}


    (function(){
  try{
    const pending = localStorage.getItem("pending_card_order_id") || "";
    if (!pending) return;

    const u = new URL(location.href);
    const ok =
      u.searchParams.get("paid") === "1" ||
      u.searchParams.get("success") === "1" ||
      u.searchParams.get("status") === "success";

    // ✅ 只有「付款成功」回跳才發卡
    if (ok) {
      sendOrderSubmittedCardOnce(pending);
      localStorage.removeItem("pending_card_order_id");
    }
  }catch(e){}
})();



    /* --- 邏輯控制核心 --- */

    // 1. 監聽付款方式，連動運送選項
    const elPay = document.getElementById("payMethod");
    const elShip = document.getElementById("shipMethod");
    const elCvsBox = document.getElementById("cvsBox");
    // ===== 7-11 e-map：選店 + 回填 =====
    const cvsStoreIdEl   = document.getElementById("cvsStoreId");
    const cvsStoreNameEl = document.getElementById("cvsStoreName");
    const cvsAddrEl      = document.getElementById("cvsAddr");
    const btnPick711     = document.getElementById("btnPick711");

    function qget(k){
      const u = new URL(location.href);
      let v = u.searchParams.get(k);
      if (!v) return "";
      // 兼容 + 變空白
      return decodeURIComponent(String(v).replace(/\+/g, "%20"));
    }

    function applyStoreFromQuery(){
      const sid = qget("store_id");
      if (!sid) return;

      const sname = qget("store_name");
      const saddr = qget("store_addr");

      if (cvsStoreIdEl)   cvsStoreIdEl.value = sid;
      if (cvsStoreNameEl) cvsStoreNameEl.value = sname;
      if (cvsAddrEl)      cvsAddrEl.value = saddr;

      // 確保切到 7-11 運送，並顯示 cvsBox
      try{
        if (elShip) elShip.value = "cvs_711";
        updateInputBoxes();
      }catch(e){}

      // 可選：把 store_* 從網址拿掉（避免客人看到一堆參數）
      try{
        const u = new URL(location.href);
        ["store_id","store_name","store_addr","store_src"].forEach(x => u.searchParams.delete(x));
        history.replaceState(null, "", u.toString());
      }catch(e){}
    }

    function open711Map(){
      const pay = (elPay?.value || "").trim();
      const src = (pay === "cvs_cod") ? "cod" : "paid";
      const customer = (document.getElementById("name")?.value || "").trim() || "guest";

      saveDraft();

      const go = `${API}/cvs/map?src=${encodeURIComponent(src)}&cart_token=${encodeURIComponent(cart_token)}&customer=${encodeURIComponent(customer)}`;
      location.href = go;
    }

    btnPick711?.addEventListener("click", open711Map);

    const elHomeBox = document.getElementById("homeBox");

    const BANK_INFO = `銀行：合作金庫(006)
戶名：沐雨精品服飾
帳號：0610717042541`;

    const bankBox = document.getElementById("bankBox");
    const bankText = document.getElementById("bankText");
    const btnCopyBank = document.getElementById("btnCopyBank");

    // ===== 表單草稿：跳選店前保存，回來自動還原 =====
    const DRAFT_KEY = `murain_checkout_draft_${cart_token}`;

    function saveDraft(){
      try{
        const draft = {
          name:  document.getElementById("name")?.value || "",
          phone: document.getElementById("phone")?.value || "",
          email: document.getElementById("email")?.value || "",
          note:  document.getElementById("note")?.value || "",
          pay:   document.getElementById("payMethod")?.value || "",
          ship:  document.getElementById("shipMethod")?.value || "",
          address: document.getElementById("address")?.value || "",
        };
        localStorage.setItem(DRAFT_KEY, JSON.stringify(draft));
      }catch(e){}
    }

    function loadDraft(){
      try{
        const s = localStorage.getItem(DRAFT_KEY);
        if(!s) return;
        const d = JSON.parse(s);

        const nameEl = document.getElementById("name");
        const phoneEl = document.getElementById("phone");
        const emailEl = document.getElementById("email");
        const noteEl = document.getElementById("note");
        const addrEl = document.getElementById("address");
        const payEl = document.getElementById("payMethod");
        const shipEl = document.getElementById("shipMethod");

        if (nameEl && d.name && !nameEl.value) nameEl.value = d.name;
        if (phoneEl && d.phone && !phoneEl.value) phoneEl.value = d.phone;
        if (emailEl && d.email && !emailEl.value) emailEl.value = d.email;
        if (noteEl && d.note && !noteEl.value) noteEl.value = d.note;
        if (addrEl && d.address && !addrEl.value) addrEl.value = d.address;

        // 先還原付款→重建運送選項→再還原運送
        if (payEl && d.pay) payEl.value = d.pay;
        try{ updateShipOptions(); }catch(e){}
        if (shipEl && d.ship) shipEl.value = d.ship;
        try{ updateInputBoxes(); }catch(e){}
      }catch(e){}
    }

    function updateShipOptions() {
      const pay = elPay.value;
      // 匯款資訊顯示/隱藏
      if (bankBox && bankText) {
        if (pay === "bank_transfer") {
          bankBox.style.display = "";
          bankText.textContent = BANK_INFO;
        } else {
          bankBox.style.display = "none";
        }
      }
      
      // 先清空運送選項
      elShip.innerHTML = "";
      if(pay === "cvs_cod") {
        // 若選 7-11 貨到付款 -> 只能選 7-11 取貨
        let opt = new Option("7-11 門市取貨", "cvs_711");
        elShip.add(opt);
      } else {
        // 其他 (匯款、線上支付) -> 可選 7-11 或 宅配
        elShip.add(new Option("7-11 門市取貨", "cvs_711"));
        elShip.add(new Option("中華郵政 - 郵寄", "home"));
      }
      elShip.disabled = (pay === "cvs_cod");
      if (pay === "cvs_cod") elShip.value = "cvs_711";
      updateInputBoxes();
    }

    function updateInputBoxes() {
      const ship = elShip.value;
      if(ship === "cvs_711") {
        elCvsBox.style.display = "block";
        elHomeBox.style.display = "none";
      } else {
        elCvsBox.style.display = "none";
        elHomeBox.style.display = "block";
      }
    }

    elPay.addEventListener("change", updateShipOptions);
    elShip.addEventListener("change", updateInputBoxes);
    
    // 初始化
    loadDraft();
    updateShipOptions();
    applyStoreFromQuery();

    btnCopyBank?.addEventListener('click', async ()=>{
      try{
        await navigator.clipboard.writeText(BANK_INFO);
        toast('已複製匯款資訊 ✅');
      }catch(e){
        const ta=document.createElement('textarea');
        ta.value=BANK_INFO; document.body.appendChild(ta);
        ta.select(); document.execCommand('copy');
        ta.remove();
        toast('已複製匯款資訊 ✅');
      }
    });

    /* --- 載入購物車 --- */
    async function loadCart(){
      try{
        const data = await apiGet(`${API}/cart/get?cart_token=${encodeURIComponent(cart_token)}`);
        const items = Array.isArray(data.items) ? data.items : [];
        const total = Number(data.total_amount||0) || 0;
        totalEl.textContent = money(total);

        if (!items.length){
          itemsEl.innerHTML = `<div style="text-align:center;color:#666;padding:20px">購物車是空的</div>`;
          return;
        }

        itemsEl.innerHTML = items.map(it => `
          <div class="cart-item">
            <div class="item-info">
              <div class="item-name">${escapeHtml(it.title||it.sku||"")}</div>
              <div class="item-meta">SKU: ${escapeHtml(it.sku)} | Qty: ${it.qty}</div>
            </div>
            <div class="item-price">$ ${money(Number(it.price)*Number(it.qty))}</div>
          </div>
        `).join("");
      }catch(e){
        itemsEl.innerHTML = "讀取失敗";
      }
    }

    /* --- 送出訂單 --- */
    document.getElementById("btnSubmit").onclick = async ()=>{
      if (LIFF_ID && !LINE.ok){ toast("請先完成 LINE 登入"); return; }

      const name = document.getElementById("name").value.trim();
      const phone = document.getElementById("phone").value.trim();
      const email = document.getElementById("email").value.trim();
      const note = document.getElementById("note").value.trim();
      const payMethod = elPay.value;
      const shipMethod = elShip.value;

      if (!payMethod) { toast("請選擇付款方式"); return; }
      if (!name || !phone || !email){ toast("請填寫完整聯絡資料"); return; }

      const shippingInfo = {
        line_user_id: LINE.userId || "",
        line_name: LINE.name || "",
        email,
        ship_method: shipMethod,
        pay_method: payMethod,
      };

      let address = "";
      // 驗證地址或門市資料
      if (shipMethod === "home"){
        address = document.getElementById("address").value.trim();
        if (!address){ toast("請填寫郵寄地址"); return; }
        shippingInfo.address = address;
      }
      if (shipMethod === "cvs_711"){
        const storeId = document.getElementById("cvsStoreId").value.trim();
        const storeName = document.getElementById("cvsStoreName").value.trim();
        const storeAddr = document.getElementById("cvsAddr").value.trim();
        if (!storeId || !storeName){ toast("請填寫 7-11 門市代號與名稱"); return; }
        shippingInfo.cvs = { store_id: storeId, store_name: storeName, store_addr: storeAddr };
      }

      const btn = document.getElementById("btnSubmit");
      const msg = document.getElementById("submitMsg");
      btn.disabled = true;
      msg.textContent = "處理中...";

      try{
        const r = await apiPost(`${API}/checkout`, {
          cart_token,
          customer_name: name,
          phone,
          address: address || "",
          note,
          payment_method: payMethod,
          shipping_method: shipMethod,
          shipping_info_json: JSON.stringify(shippingInfo),
        });

        msg.textContent = "";
        const orderId = r.order_id || "";
        const total = r.total_amount || 0;
        
        // 修正：調整這裡的內嵌樣式顏色，適應白色背景
        document.getElementById("result").innerHTML = `
          <div style="background:#fcfcfc;border:2px solid var(--gold);padding:20px;border-radius:12px;text-align:center;margin-top:20px;box-shadow:0 4px 15px rgba(0,0,0,0.05)">
            <h2 style="color:var(--gold);margin:0 0 10px">✅ 訂單已建立</h2>
            <div style="font-size:18px;font-weight:bold;color:#333">編號：${escapeHtml(orderId)}</div>
            <div style="font-size:16px;color:#555;margin-top:5px">金額：$ ${money(total)}</div>
            <div style="font-size:13px;color:#777;margin-top:15px;line-height:1.6">
              感謝您的購買。<br>
              若選擇線上支付，頁面即將跳轉至付款頁面...
            </div>
            <a href="./index.html" style="display:inline-block;margin-top:20px;color:var(--gold);text-decoration:underline;font-weight:bold;">返回官網</a>
          </div>
        `;
        
        // 隱藏表單
        document.querySelector(".container").style.display = "none";
        document.querySelector(".hero-banner").style.display = "none";
        document.querySelector("#result").style.display = "block";
        // 將結果移出 container 顯示
        document.querySelector(".wrap").appendChild(document.getElementById("result"));

                toast("訂單建立成功");

// ✅ 線上付款：先不發卡，只記住這張單，等付款成功回來才發
if (r.payment_url) {
  try{ localStorage.setItem("pending_card_order_id", orderId); }catch(e){}
  setTimeout(() => location.href = r.payment_url, 1500);
} else {
  // ✅ 非線上付款（匯款/貨到付款）：立刻發卡
  sendOrderSubmittedCardOnce(orderId);
}

      }catch(e){
        btn.disabled = false;
        msg.textContent = "";
        toast("送出失敗：" + (e?.message || "error"));
      }
    };

    function escapeHtml(s){
      return String(s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }

    loadCart();
  </script>
</body>
</html>
