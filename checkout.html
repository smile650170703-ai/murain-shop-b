<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MURAIN 寄賣精品｜結帳</title>
  <meta name="robots" content="noindex,nofollow" />
  <style>
    :root{
      --bg:#07060a; --card:#0f0e14; --gold:#c9a24a; --gold2:#f2d27a;
      --text:#f2f2f2; --muted:#b7b7b7; --line:rgba(201,162,74,.28);
      --shadow:0 12px 40px rgba(0,0,0,.55); --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Noto Sans TC", Segoe UI, Arial;
      background:
        radial-gradient(1200px 600px at 20% 10%, rgba(201,162,74,.12), transparent 55%),
        radial-gradient(900px 500px at 80% 0%, rgba(242,210,122,.10), transparent 60%),
        var(--bg);
      color:var(--text);
    }
    .wrap{max-width:980px;margin:0 auto;padding:26px 18px 60px;}
    .card{
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(18,17,26,.92), rgba(10,10,14,.92));
      box-shadow: var(--shadow);
      padding:16px;
    }
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .k{color:var(--muted);font-size:12px}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
    .btn{
      cursor:pointer;
      border:1px solid var(--line);
      background: radial-gradient(120px 60px at 30% 30%, rgba(242,210,122,.16), rgba(201,162,74,.10));
      color:var(--text);
      padding:10px 12px;border-radius: 12px;font-weight:800;
    }
    .btnGhost{
      cursor:pointer;border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.25);color:var(--text);
      padding:10px 12px;border-radius: 12px;font-weight:800;
    }
    .input,.select,.textarea{
      width:100%;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.25);
      color:var(--text);
      padding:10px 12px;border-radius: 12px;outline:none;
    }
    .textarea{min-height:90px;resize:vertical}
    h1{margin:0 0 8px;font-size:20px}
    .items{margin-top:10px;border-top:1px solid rgba(255,255,255,.10)}
    .item{display:flex;justify-content:space-between;gap:12px;padding:10px 0;border-bottom:1px solid rgba(255,255,255,.10)}
    .price{color:var(--gold2);font-weight:900}
    .hr{height:1px;background:rgba(255,255,255,.10);margin:14px 0}
    .toast{position:fixed;left:50%;bottom:22px;transform:translateX(-50%);background:rgba(0,0,0,.75);border:1px solid rgba(201,162,74,.35);color:var(--text);padding:10px 12px;border-radius:999px;display:none;z-index:999}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div>
          <h1>結帳購物車</h1>
          <div class="k">API：<span class="mono" id="apiText"></span></div>
          <div class="k">cart_token：<span class="mono" id="cartText"></span></div>
        </div>
        <div class="row">
          <button class="btnGhost" onclick="location.href='./index.html'">回寄賣官網</button>
          <button class="btnGhost" id="btnReload">刷新</button>
          <button class="btnGhost" id="btnChange">換一個 token</button>
        </div>
      </div>

      <div class="items" id="items"></div>
      <div class="row" style="justify-content:space-between;margin-top:10px">
        <div class="k" id="cartMsg"></div>
        <div style="font-size:18px;font-weight:900">合計 <span class="price">$ <span id="total">0</span></span></div>
      </div>

      <div class="hr"></div>

      <h1 style="font-size:16px;margin-top:0">填寫資料並送出訂單</h1>
      <div class="k">（匯款 / 面交 / 7-11 貨到付款：你確認收款後再按後台開發票；線上支付：之後串 PayUNI 回呼成功自動開）</div>

      <div class="row" style="margin-top:12px">
        <input class="input" id="name" placeholder="姓名（必填）" style="flex:1;min-width:180px" />
        <input class="input" id="phone" placeholder="手機（必填）" style="flex:1;min-width:180px" />
      </div>
      <div class="row">
        <input class="input" id="email" placeholder="Email（必填：發票寄送用）" style="flex:1;min-width:260px" />
      </div>

      <div class="row" style="margin-top:8px">
        <select class="select" id="shipMethod" style="flex:1;min-width:220px">
          <option value="cvs_711">7-11 取貨 / 貨到付款（先填門市資料）</option>
          <option value="home">郵寄 / 宅配（填地址）</option>
          <option value="meet">面交</option>
        </select>

        <select class="select" id="payMethod" style="flex:1;min-width:260px">
          <option value="cvs_cod">7-11 貨到付款</option>
          <option value="bank_transfer">匯款</option>
          <option value="meet_pay">面交付款</option>
          <option value="payuni_card">線上支付：信用卡一次付（待串接）</option>
          <option value="payuni_3">線上支付：3 期零利率（待串接）</option>
          <option value="payuni_6">線上支付：6 期零利率（待串接）</option>
          <option value="payuni_9">線上支付：9 期零利率（待串接）</option>
          <option value="payuni_af">線上支付：AF 先享後付（待串接）</option>
          <option value="payuni_linepay">線上支付：LINE PAY（待串接）</option>
        </select>
      </div>

      <!-- 7-11 -->
      <div id="cvsBox" style="margin-top:10px">
        <div class="k">7-11 門市資訊（先用手動填；之後你要串「跳門市選擇」我再幫你接）</div>
        <div class="row" style="margin-top:8px">
          <input class="input" id="cvsStoreId" placeholder="門市代號（例：123456）" style="flex:1;min-width:160px" />
          <input class="input" id="cvsStoreName" placeholder="門市名稱" style="flex:2;min-width:240px" />
        </div>
        <input class="input" id="cvsAddr" placeholder="門市地址（可選）" style="margin-top:8px" />
      </div>

      <!-- home -->
      <div id="homeBox" style="margin-top:10px;display:none">
        <div class="k">郵寄 / 宅配地址</div>
        <textarea class="textarea" id="address" placeholder="地址（例：台南市xx區xx路xx號）" style="margin-top:8px"></textarea>
      </div>

      <textarea class="textarea" id="note" placeholder="備註（可選：匯款末五碼 / 取件偏好等）" style="margin-top:10px"></textarea>

      <div class="row" style="margin-top:12px">
        <button class="btn" id="btnSubmit" style="min-width:160px">送出訂單</button>
        <div class="k" id="submitMsg"></div>
      </div>

      <div class="hr"></div>

      <div class="k" id="result"></div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <!-- LIFF -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
    const API_DEFAULT = "https://api2.murain.tw";
    const LIFF_ID = ""; // 你要強制 LINE 登入就填上
    const API = new URL(location.href).searchParams.get("api") || API_DEFAULT;

    const elApi = document.getElementById("apiText");
    const elCart = document.getElementById("cartText");
    const itemsEl = document.getElementById("items");
    const cartMsg = document.getElementById("cartMsg");
    const totalEl = document.getElementById("total");
    const toastEl = document.getElementById("toast");

    elApi.textContent = API;

    const LS_TOKEN = "murain_b_cart_token";
    function genToken(){
      const s = Math.random().toString(36).slice(2, 6) + Date.now().toString(36).slice(-4);
      return "b" + s;
    }
    function getToken(){
      const u = new URL(location.href);
      const tQ = u.searchParams.get("cart");
      if (tQ) { localStorage.setItem(LS_TOKEN, tQ); return tQ; }
      let t = localStorage.getItem(LS_TOKEN);
      if (!t){ t = genToken(); localStorage.setItem(LS_TOKEN, t); }
      return t;
    }

    function money(n){
      try{ return new Intl.NumberFormat("zh-TW").format(Number(n||0)); }catch{ return String(n||0); }
    }
    function toast(t){
      toastEl.textContent = t;
      toastEl.style.display = "block";
      clearTimeout(toastEl._t);
      toastEl._t = setTimeout(()=> toastEl.style.display="none", 1800);
    }
    async function apiGet(u){
      const res = await fetch(u, { method:"GET" });
      const j = await res.json().catch(()=>null);
      if (!res.ok) throw new Error(j?.message || j?.error || "fetch_failed");
      return j;
    }
    async function apiPost(u, data){
      const res = await fetch(u, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(data||{})
      });
      const j = await res.json().catch(()=>null);
      if (!res.ok) throw new Error(j?.message || j?.error || "post_failed");
      return j;
    }

    let LINE = { ok:false, userId:"", idToken:"", name:"" };
    async function initLINE(){
      if (!LIFF_ID) return;
      try{
        await liff.init({ liffId: LIFF_ID });
        if (!liff.isLoggedIn()) liff.login();
        const prof = await liff.getProfile();
        LINE.ok = true;
        LINE.userId = prof.userId || "";
        LINE.name = prof.displayName || "";
        LINE.idToken = liff.getIDToken() || "";
      }catch(e){}
    }
    initLINE();

    const cart_token = getToken();
    elCart.textContent = cart_token;

    document.getElementById("btnReload").onclick = ()=> loadCart();
    document.getElementById("btnChange").onclick = ()=>{
      const t = genToken();
      localStorage.setItem(LS_TOKEN, t);
      location.href = `./checkout.html?cart=${encodeURIComponent(t)}`;
    };

    function setShipUI(){
      const ship = document.getElementById("shipMethod").value;
      document.getElementById("cvsBox").style.display = (ship === "cvs_711") ? "block" : "none";
      document.getElementById("homeBox").style.display = (ship === "home") ? "block" : "none";
    }
    document.getElementById("shipMethod").addEventListener("change", setShipUI);
    setShipUI();

    async function loadCart(){
      itemsEl.innerHTML = "";
      cartMsg.textContent = "載入購物車…";
      try{
        const data = await apiGet(`${API}/cart/get?cart_token=${encodeURIComponent(cart_token)}`);
        const items = Array.isArray(data.items) ? data.items : [];
        const total = Number(data.total_amount||0) || 0;
        totalEl.textContent = money(total);

        if (!items.length){
          cartMsg.textContent = "購物車是空的，請回官網加入商品。";
          itemsEl.innerHTML = "";
          return;
        }

        cartMsg.textContent = "";
        itemsEl.innerHTML = items.map(it=>`
          <div class="item">
            <div>
              <div style="font-weight:900">${escapeHtml(it.title||it.sku||"")}</div>
              <div class="k mono">SKU：${escapeHtml(it.sku||"")}　qty：${Number(it.qty||0)}　單價：$ ${money(it.price||0)}</div>
            </div>
            <div class="price">$ ${money((Number(it.qty||0)||0) * (Number(it.price||0)||0))}</div>
          </div>
        `).join("");

      }catch(e){
        cartMsg.textContent = "讀取失敗：" + (e?.message || "error");
      }
    }

    document.getElementById("btnSubmit").onclick = async ()=>{
      // 強制 LINE 登入（你正式要「一定要」就把 LIFF_ID 填上）
      if (LIFF_ID && !LINE.ok){
        toast("請先完成 LINE 登入");
        return;
      }

      const name = (document.getElementById("name").value||"").trim();
      const phone = (document.getElementById("phone").value||"").trim();
      const email = (document.getElementById("email").value||"").trim();
      const note = (document.getElementById("note").value||"").trim();
      const shipMethod = document.getElementById("shipMethod").value;
      const payMethod = document.getElementById("payMethod").value;

      if (!name || !phone || !email){
        toast("請填姓名 / 手機 / Email");
        return;
      }

      const shippingInfo = {
        line_user_id: LINE.userId || "",
        line_name: LINE.name || "",
        email,
        ship_method: shipMethod,
        pay_method: payMethod,
      };

      let address = "";
      if (shipMethod === "home"){
        address = (document.getElementById("address").value||"").trim();
        if (!address){ toast("請填寫郵寄地址"); return; }
        shippingInfo.address = address;
      }
      if (shipMethod === "cvs_711"){
        const storeId = (document.getElementById("cvsStoreId").value||"").trim();
        const storeName = (document.getElementById("cvsStoreName").value||"").trim();
        const storeAddr = (document.getElementById("cvsAddr").value||"").trim();
        if (!storeId || !storeName){
          toast("請填 7-11 門市代號 / 名稱");
          return;
        }
        shippingInfo.cvs = { store_id: storeId, store_name: storeName, store_addr: storeAddr };
      }

      const submitMsg = document.getElementById("submitMsg");
      submitMsg.textContent = "送出中…";

      try{
        const r = await apiPost(`${API}/checkout`, {
          cart_token,
          customer_name: name,
          phone,
          address: address || "",
          note,
          payment_method: payMethod,
          shipping_method: shipMethod,
          shipping_info_json: JSON.stringify(shippingInfo),
        });

        submitMsg.textContent = "";
        const orderId = r.order_id || "";
        const total = r.total_amount || 0;
        document.getElementById("result").innerHTML =
          `<div style="font-weight:900;color:var(--gold2)">✅ 已建立訂單：${escapeHtml(orderId)}　金額 $ ${money(total)}</div>
           <div class="k" style="margin-top:6px">
             匯款/面交/貨到付款：到後台確認收款後再按「開立發票」。<br/>
             線上支付：下一步會接 PayUNI（你要我接回呼與自動開票，我再幫你接到後端 routes）。
           </div>`;

        toast("訂單已建立");
        await loadCart(); // 會變空（你後端是 qty=0 清購物車）
      }catch(e){
        submitMsg.textContent = "";
        toast("送出失敗：" + (e?.message || "error"));
      }
    };

    function escapeHtml(s){
      return String(s||"")
        .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }

    loadCart();
  </script>
</body>
</html>
